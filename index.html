<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coaching ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ« - Workshop Edition</title>
<style>
/* --- ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
:root{
  --bg:#ffffff; --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; 
  --accent:#3b82f6; --accent-2:#10b981; --card:#ffffff; 
  --shadow:0 10px 24px rgba(0,0,0,.06);
  
  /* Seasonal Mode Defaults (JSã§ä¸Šæ›¸ãã•ã‚Œã¾ã™) */
  --season-bg: #fffbf0;
  --season-accent: #ef4444;
  --season-sub: #f59e0b;
  
  /* Animal Mode Colors */
  --animal-bg: #fff1f2; 
  --animal-accent: #f472b6;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  transition: background 1.0s ease, color 0.5s ease;
}

/* --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« --- */
/* Seasonal Mode (æœˆæ›¿ã‚ã‚Š) */
body.mode-seasonal { 
  background: var(--season-bg); 
  color: #4b2c20; 
}
body.mode-seasonal .panel, 
body.mode-seasonal .role, 
body.mode-seasonal .matrix-cell, 
body.mode-seasonal .schedule-box { 
  background: rgba(255, 255, 255, 0.95); 
  border-color: var(--season-sub); 
  color: #4b2c20; 
}
body.mode-seasonal .lucky-box {
  background: #fff;
  border-color: var(--season-accent);
  color: #4b2c20;
  box-shadow: 0 0 15px rgba(0,0,0, 0.1);
}
body.mode-seasonal .tab.active { color: var(--season-accent); border-bottom-color: var(--season-accent); }
body.mode-seasonal .primary { background: linear-gradient(135deg, var(--season-accent), var(--season-sub)); border: none; }
body.mode-seasonal .tag { background: linear-gradient(135deg, var(--season-accent), var(--season-sub)); }

/* Animal Mode */
body.mode-animal { background: var(--animal-bg); }
body.mode-animal .panel { border-color: #fbcfe8; }
body.mode-animal .primary { background: linear-gradient(135deg, #f472b6, #fb7185); box-shadow: 0 12px 28px rgba(244,114,182,0.3); }
body.mode-animal .tab.active { color: var(--animal-accent); border-bottom-color: var(--animal-accent); }
body.mode-animal .radio-tile-label input:checked + .radio-tile { border-color: var(--animal-accent); background: rgba(244, 114, 182, 0.05); box-shadow: 0 0 0 2px var(--animal-accent); }

/* å…±é€šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
body.shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
  10%, 90% { transform: translate3d(-2px, 0, 0); }
  20%, 80% { transform: translate3d(4px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
  40%, 60% { transform: translate3d(8px, 0, 0); }
}

.container{ max-width:1000px; margin:0 auto; padding:24px 16px 48px; position:relative; z-index:10; }

/* æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
#fxCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

header{ display:flex; align-items:flex-start; gap:12px; margin-bottom:16px }
.logo{ width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#60a5fa); display:grid; place-items:center; color:#fff; font-weight:900; box-shadow:var(--shadow); font-size: 24px; }
h1{ font-size:22px; margin:0 }

.panel{
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:16px; box-shadow:var(--shadow); margin-bottom:16px;
  transition: background 0.3s, border-color 0.3s;
}

/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */
.tabs { display:flex; gap:0; border-bottom:1px solid var(--border); margin: -16px -16px 16px -16px; padding: 0 16px; background: rgba(0,0,0,0.02); border-top-left-radius: 16px; border-top-right-radius: 16px; }
.tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: var(--muted); border-bottom: 2px solid transparent; font-size: 14px; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
.grid{ display:grid; grid-template-columns: repeat(3, minmax(180px,1fr)); gap:12px }
.field label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 6px }
.field input, .field textarea, .field select{
  width:100%; padding:12px 14px; background:#fff; color:var(--ink);
  border:1px solid var(--border); border-radius:12px; outline:none; font-family: inherit;
}
.field textarea { height: 120px; resize: vertical; line-height: 1.5; }
.field input:focus, .field textarea:focus, .field select:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(59,130,246,.16); }

/* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆGroup Modeç”¨ï¼‰ */
.radio-tile-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.radio-tile-label { cursor: pointer; position: relative; }
.radio-tile-label input { position: absolute; opacity: 0; pointer-events: none; }
.radio-tile { 
  display: flex; flex-direction: column; align-items: flex-start; padding: 10px; 
  border: 1px solid var(--border); border-radius: 8px; transition: all 0.2s; height: 100%;
}
.radio-tile-head { font-weight: 700; font-size: 13px; margin-bottom: 2px; display: flex; align-items: center; gap: 6px; }
.radio-tile-desc { font-size: 11px; color: var(--muted); line-height: 1.3; }
.radio-tile-label input:checked + .radio-tile { border-color: var(--accent); background: rgba(59, 130, 246, 0.05); box-shadow: 0 0 0 2px var(--accent); }

/* ãƒœã‚¿ãƒ³é¡ */
.buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px }
button{
  appearance:none; border:none; cursor:pointer;
  padding:12px 16px; border-radius:12px; font-size:15px; font-weight:600;
  transition: transform .06s ease;
}
button:active{ transform:scale(0.96); }
.primary{ color:#fff; background:linear-gradient(135deg,var(--accent),#60a5fa); box-shadow:0 12px 28px rgba(59,130,246,.24); transition: background 0.3s; }
.secondary{ color:var(--ink); background:#fff; border:1px solid var(--border); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

/* çµæœã‚«ãƒ¼ãƒ‰ (Normal Mode) */
.results{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px; perspective: 1000px; }
.round{
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:14px; box-shadow:var(--shadow);
  min-height:164px; transition: all 0.3s; position: relative; overflow: hidden;
}

/* å€‹äººã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ (Group Mode - New) */
.schedule-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 16px; box-shadow: var(--shadow); }
.schedule-header { padding: 10px 14px; background: rgba(0,0,0,0.03); font-weight: 700; font-size: 14px; border-bottom: 1px solid var(--border); color: var(--muted); }
.schedule-content { max-height: 300px; overflow-y: auto; font-size: 13px; }
.sch-row { padding: 8px 14px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
.sch-row:last-child { border-bottom: none; }
.sch-name { font-weight: 700; min-width: 80px; }
.sch-flow { flex: 1; display: flex; flex-wrap: wrap; gap: 6px; }
.flow-step { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px; }
.step-arrow { color: var(--muted); font-size: 10px; }

/* çµæœãƒ†ãƒ¼ãƒ–ãƒ« (Group Mode - Matrix) */
.matrix-container { overflow-x: auto; border:1px solid var(--border); border-radius: 12px; background: var(--card); }
.matrix { width: 100%; border-collapse: collapse; min-width: 600px; background: var(--card); }
.matrix th, .matrix td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: top; }
.matrix th { background: rgba(0,0,0,0.03); color: var(--muted); font-weight: 700; white-space: nowrap; }
.matrix-cell { transition: all 0.3s; }
.role-line { display: block; margin-bottom: 4px; }
.role-badge { display: inline-block; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; width: 60px; text-align: center; margin-right: 6px; }
.rb-coach { background: #dbeafe; color: #1e40af; }
.rb-client { background: #d1fae5; color: #065f46; }
.rb-obs { background: #f3f4f6; color: #4b5563; }

/* Seasonal Effect */
.round.seasonal-decorated, .matrix-cell.seasonal-decorated { border-color: var(--season-accent); box-shadow: 0 0 20px rgba(0,0,0, 0.1); animation: popScale 0.4s ease-out; }

/* Animal Effect */
.round.festive, .matrix-cell.festive { border-color: #f472b6; box-shadow: 0 10px 30px rgba(244, 114, 182, 0.25); animation: popScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes popScale { from{transform:scale(0.95); opacity:0;} to{transform:scale(1); opacity:1;} }

.round h3{ margin:0 0 10px; font-size:15px; display:flex; align-items:center; gap:10px; color:var(--muted); }
.badge{ color:#064e3b; background:linear-gradient(135deg,var(--accent-2),#34d399); padding:2px 10px; border-radius:999px; font-weight:800; font-size:12px; }

.assign{ display:grid; gap:10px }
.role{
  display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px;
  background:#ffffff; border:1px solid var(--border); position:relative; overflow:hidden;
}

/* åå‰æ±ºå®šæ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
.role.struck, .matrix-cell.struck, .sch-row.struck { animation: strikeFlash 0.4s ease-out forwards; }
@keyframes strikeFlash { 0% { background: #fff; filter: brightness(2); } 50% { background: #fffbeb; } 100% { background: var(--card); } }

/* ã‚¢ã‚¤ã‚³ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.deco-icon {
  font-size: 24px; margin-right: 8px; display: inline-block;
  animation: iconPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes iconPop {
  0% { transform: scale(0) rotate(-45deg); opacity: 0; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

.tag{ min-width:94px; text-align:center; color:#fff; background:linear-gradient(135deg,var(--accent),#60a5fa); border-radius:999px; font-size:12px; font-weight:800; padding:4px 10px; }

.name{ font-size:16px; font-weight:700; display:flex; align-items:center; }
.placeholder{ color:var(--muted); font-weight:500; letter-spacing:.08em }

/* è³ªå•è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ */
.lucky-box{
  margin-top:20px; padding:16px; border-radius:16px; background: #f9fafb; border: 1px solid var(--border);
  text-align:center; display:none; animation: popIn 0.4s ease-out;
}
.lucky-box.show{ display:block; }
@keyframes popIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

/* ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ */
.timer-wrap{ display:flex; flex-wrap:wrap; gap:16px; align-items:center; margin-top:10px; }
.timer-face{ min-width:240px; padding:16px; border:1px solid var(--border); border-radius:16px; background:#fff; box-shadow:var(--shadow); }
.time{ font-variant-numeric: tabular-nums; font-size:48px; font-weight:800; text-align:center; color:var(--ink); }
.time.ended{ color:#ef4444; }
.timer-sub{ text-align:center; color:var(--muted); font-size:12px; margin-top:4px }
.timer-end-msg{ text-align:center; color:#059669; font-size:14px; font-weight:700; margin-top:8px; opacity:0; }
.timer-end-msg.show{ opacity:1; }

.fx-row{ display:flex; align-items:center; gap:16px; margin-top:12px; color:var(--muted); font-size:14px; background: #f3f4f6; padding:10px; border-radius:10px; }
.radio-group { display:flex; gap:12px; }
.radio-group label { display:flex; align-items:center; gap:4px; cursor:pointer; font-weight:500; }
.preset-row, .custom-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.custom-row{ margin-top:12px; font-size:13px; color:var(--muted); }
.note{ font-weight:700; margin-right:4px; }
.num{ width:80px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px }

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer{ color:var(--muted); font-size:12px; margin-top:32px; border-top:1px solid var(--border); padding-top:12px; display:flex; flex-wrap: wrap; gap:10px; justify-content:space-between; align-items:center; }
.license{ padding:6px 10px; border-radius:10px; border:1px dashed var(--border); background:#fafafa; line-height: 1.4; }

/* åˆæ„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:16px; z-index:2000; }
.dialog{ max-width:600px; width:100%; background:#fff; border-radius:16px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,.4); }
.dialog h2{ margin:0 0 12px; font-size:20px; }
.bullet li{ margin:8px 0; line-height:1.6; color:#374151; }

@media (max-width:720px){ 
  .grid{ grid-template-columns: 1fr } 
  .radio-tile-group { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<canvas id="fxCanvas"></canvas>

<div id="consentOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="dialog">
    <h2 id="consentTitle">åˆæ„ã®ç¢ºèª</h2>
    <p>æœ¬ã‚¢ãƒ—ãƒªã¯ã€ã‚³ãƒ¼ãƒãƒ³ã‚°ã®ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ«ã‚’ã€ŒåŠ¹ç‡çš„ã«ãƒ»éŠã³å¿ƒã‚’ã‚‚ã£ã¦ã€è¡Œã†ãŸã‚ã®å ´ã¥ãã‚Šã‚’æ”¯æ´ã—ã¾ã™ã€‚å®‰å¿ƒãƒ»å®‰å…¨ãªå­¦ã³ã®ãŸã‚ã€ä»¥ä¸‹ã«åŒæ„ã®ã†ãˆé–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
    <ul class="bullet">
      <li><strong>å®ˆç§˜ç¾©å‹™</strong>: ã“ã“ã§è©±ã•ã‚ŒãŸå†…å®¹ã¯ç›¸æ‰‹ã®äº†æ‰¿ãªãå ´ã®å¤–ã«æŒã¡å‡ºã—ã¾ã›ã‚“ã€‚</li>
      <li><strong>å­¦ã³ã¨å®Ÿé¨“ã®å ´</strong>: å®Œç’§ã•ã§ã¯ãªãå­¦ã³ãƒ»æŒ‘æˆ¦ã‚’å°Šé‡ã—ã¾ã™ã€‚ã†ã¾ãã„ã‹ãªã„ã“ã¨ã‚‚å®Ÿé¨“ã®ä¸€éƒ¨ã§ã™ã€‚</li>
      <li><strong>å…±ã«å‰µã‚‹</strong>: ç›¸äº’æ‰¿èªãƒ»æ™‚é–“å³å®ˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ã€å ´ã‚’ä¸€ç·’ã«è‰¯ãã—ã¦ã„ãã¾ã™ã€‚</li>
    </ul>
    <div class="buttons" style="margin-top:20px; justify-content:center;">
      <button id="consentOk" class="primary" style="padding:12px 24px;">OKï¼ˆåŒæ„ã—ã¦å§‹ã‚ã‚‹ï¼‰</button>
    </div>
  </div>
</div>

<div class="container" aria-hidden="true" id="appRoot">
  <header>
    <div id="mainLogo" class="logo" aria-hidden="true">ğŸ‘¹</div>
    <div>
      <h1>Coaching ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ«</h1>
    </div>
  </header>

  <section class="panel">
    <div class="tabs">
        <div class="tab active" data-target="mode-normal">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ (3-4å)</div>
        <div class="tab" data-target="mode-group">ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ (å¤§äººæ•°)</div>
    </div>

    <div id="mode-normal" class="tab-content active">
        <div style="font-weight:700;margin-bottom:8px">å‚åŠ è€…ã¨æŠ½é¸</div>
        <div class="grid">
          <div class="field"><label>å‚åŠ è€…1</label><input id="p1" type="text" placeholder="å‚åŠ è€…1"></div>
          <div class="field"><label>å‚åŠ è€…2</label><input id="p2" type="text" placeholder="å‚åŠ è€…2"></div>
          <div class="field"><label>å‚åŠ è€…3</label><input id="p3" type="text" placeholder="å‚åŠ è€…3"></div>
          <div class="field"><label>å‚åŠ è€…4 (ä»»æ„)</label><input id="p4" type="text" placeholder="å‚åŠ è€…4"></div>
        </div>
    </div>

    <div id="mode-group" class="tab-content">
        <div style="font-weight:700;margin-bottom:8px">ãƒ¯ãƒ¼ã‚¯å½¢å¼ã‚’é¸æŠ</div>
        <div class="radio-tile-group">
            <label class="radio-tile-label">
                <input type="radio" name="workType" value="A" checked>
                <div class="radio-tile">
                    <div class="radio-tile-head">å‹Aï¼šã˜ã£ãã‚Šæ·±åŒ–ï¼ˆ3äºº/éƒ¨å±‹å›ºå®šï¼‰</div>
                    <div class="radio-tile-desc">éƒ¨å±‹ã‚’å›ºå®šã—ã€å½¹å‰²ï¼ˆC/Cl/Obï¼‰ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚å®‰å®šã—ã¦é–¢ä¿‚æ€§ã‚’æ·±ã‚ã¾ã™ã€‚ï¼ˆä½™ã‚Šã¯4åor2åã«èª¿æ•´ï¼‰</div>
                </div>
            </label>
            <label class="radio-tile-label">
                <input type="radio" name="workType" value="B">
                <div class="radio-tile">
                    <div class="radio-tile-head">å‹Bï¼šãƒšã‚¢é›†ä¸­ï¼ˆ2äºº/éƒ¨å±‹å›ºå®šï¼‰</div>
                    <div class="radio-tile-desc">éƒ¨å±‹ã‚’å›ºå®šã—ã€äº¤äº’ã«ã‚³ãƒ¼ãƒãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®Ÿæ–½ã€‚1å¯¾1ã§é›†ä¸­ã—ã¾ã™ã€‚ï¼ˆå¥‡æ•°ã®å ´åˆã€1çµ„ã ã‘3åï¼‰</div>
                </div>
            </label>
            <label class="radio-tile-label">
                <input type="radio" name="workType" value="C">
                <div class="radio-tile">
                    <div class="radio-tile-head">å‹Cï¼šãƒˆãƒªã‚ªæ¢æ±‚ï¼ˆ3äºº/æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰</div>
                    <div class="radio-tile-desc">ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«3äººçµ„ã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚éå»ã«çµ„ã‚“ã ç›¸æ‰‹ã¨é‡è¤‡ã›ãšã€ã‹ã¤å½¹å‰²ã‚‚å‡ç­‰ã«ãªã‚‹ã‚ˆã†èª¿æ•´ã—ã¾ã™ã€‚</div>
                </div>
            </label>
            <label class="radio-tile-label">
                <input type="radio" name="workType" value="D">
                <div class="radio-tile">
                    <div class="radio-tile-head">å‹Dï¼šãƒšã‚¢ä¿®è¡Œï¼ˆ2äºº/æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰</div>
                    <div class="radio-tile-desc">ãƒ©ã‚¦ãƒ³ãƒ‰ã”ã¨ã«2äººçµ„ã‚’ä½œã‚Šç›´ã—ã¾ã™ã€‚æ§˜ã€…ãªç›¸æ‰‹ã¨è³ªé‡ã®é«˜ã„ç·´ç¿’ã‚’è¡Œã„ãŸã„å ´åˆã«æœ€é©ã§ã™ã€‚</div>
                </div>
            </label>
        </div>

        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <div class="field">
                <label>å‚åŠ è€…ãƒªã‚¹ãƒˆï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šã§å…¥åŠ›ï¼‰</label>
                <textarea id="bulkParticipants" placeholder="ä½è—¤&#13;&#10;éˆ´æœ¨&#13;&#10;ç”°ä¸­&#13;&#10;é«˜æ©‹&#13;&#10;ä¼Šè—¤&#13;&#10;..."></textarea>
            </div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <div class="field">
                    <label>ãƒ©ã‚¦ãƒ³ãƒ‰æ•°</label>
                    <select id="roundCount">
                        <option value="1">1å›</option>
                        <option value="2">2å›</option>
                        <option value="3" selected>3å›</option>
                        <option value="4">4å›</option>
                        <option value="5">5å›</option>
                    </select>
                </div>
                <div style="font-size:12px; color:var(--muted); line-height:1.4;">
                    <strong>ãƒã‚¤ãƒ³ãƒˆ:</strong><br>
                    - å‹C/Dã¯è‡ªå‹•ã§é‡è¤‡å›é¿è¨ˆç®—ã‚’è¡Œã„ã¾ã™<br>
                    - ç«¯æ•°ã¯è‡ªå‹•çš„ã«èª¿æ•´ã•ã‚Œã¾ã™
                </div>
            </div>
        </div>
    </div>

    <div class="buttons" style="margin-top:16px;">
      <button id="drawBtn" class="primary">æŠ½é¸ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘</button>
      <button id="redrawBtn" class="secondary" disabled>ã‚‚ã†ä¸€åº¦</button>
      <button id="copyBtn" class="secondary" disabled>çµæœã‚³ãƒ”ãƒ¼</button>
      <button id="copyCsvBtn" class="secondary" disabled style="display:none;">Zoom CSVã‚³ãƒ”ãƒ¼</button>
    </div>
    
    <div class="fx-row">
      <span style="font-weight:700">æ¼”å‡ºãƒ¢ãƒ¼ãƒ‰:</span>
      <div class="radio-group">
        <label><input type="radio" name="fxMode" value="seasonal" checked> ğŸ“…SEASON</label>
        <label><input type="radio" name="fxMode" value="animal"> ğŸ»ANIMAL</label>
        <label><input type="radio" name="fxMode" value="none"> ğŸš«ç„¡åŠ¹</label>
      </div>
    </div>
  </section>

  <section id="results" class="results" aria-live="polite"></section>

  <div id="luckyBox" class="lucky-box">
    <div style="font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px">Topic</div>
    <div id="luckyText" class="lucky-text"></div>
  </div>

  <section class="panel" style="margin-top:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700;">ã‚¿ã‚¤ãƒãƒ¼</div>
<div class="preset-row">
  <span class="note">ãƒ—ãƒªã‚»ãƒƒãƒˆ:</span>
  <button class="chip secondary" data-min="15">15åˆ†</button>
  <button class="chip secondary" data-min="20">20åˆ†</button> 
  <button class="chip secondary" data-min="25">25åˆ†</button>
  <button class="chip secondary" data-min="30">30åˆ†</button>
</div>
    </div>

    <div class="custom-row">
      <span class="note">ã‚«ã‚¹ã‚¿ãƒ :</span>
      <input id="mInput" class="num" type="number" min="0" value="25"> åˆ†
      <input id="sInput" class="num" type="number" min="0" value="0"> ç§’
      <button id="applyCustom" class="secondary">é©ç”¨</button>
    </div>

    <div class="custom-row">
      <span class="note">å‘¼éˆ´ï¼ˆnåˆ†å‰ï¼‰:</span>
      <label for="chimeToggle" style="display:flex;align-items:center;gap:4px;margin-right:8px">
        <input type="checkbox" id="chimeToggle" checked> æœ‰åŠ¹
      </label>
      <input id="chimeM" class="num" type="number" min="0" value="3"> åˆ†å‰
      <button id="applyChime" class="secondary">è¨­å®š</button>
    </div>
    
    <div class="timer-wrap">
      <div class="timer-face">
        <div id="time" class="time">25:00</div> 
        <div id="timeNote" class="timer-sub">ã‚»ãƒƒãƒˆ: 25åˆ† 0ç§’</div>
        <div id="chimeNote" class="timer-sub">å‘¼éˆ´: 3åˆ†å‰</div>
        <div id="endMsg" class="timer-end-msg"></div>
      </div>
      <div class="buttons" style="flex:1">
        <button id="startPause" class="primary" style="padding:12px 32px">é–‹å§‹</button>
        <button id="resetTimer" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="popupBtn" class="secondary">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º</button>
      </div>
    </div>
  </section>

  <div class="footer">
    <div>Created by Naomitchy</div>
    <div class="license">ã“ã®ã‚¢ãƒ—ãƒªã¯ CC0 ï¼ˆè‘—ä½œæ¨©æ”¾æ£„ãƒ»No Rights Reservedï¼‰ç›¸å½“ã§æä¾›ã—ã¾ã™ã€‚å‡ºå…¸ä¸è¦ãƒ»æ”¹å¤‰ãƒ»å†é…å¸ƒã‚‚è‡ªç”±ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
  </div>
</div>

<script>
(function(){
'use strict';

/* --- æœˆåˆ¥ãƒ†ãƒ¼ãƒå®šç¾© --- */
const MONTH_THEMES = {
  1: {
    name: "ãŠæ­£æœˆ",
    bg: "#fffbf0", accent: "#ef4444", sub: "#fbbf24", // ç´…ç™½ãƒ»é‡‘
    icons: ['ğŸ','ğŸŒ…','ğŸ','ğŸŒ¸','ğŸ—','âœ¨','ğŸ´'],
    particle: 'confetti-gold',
    sound: 'japanese' 
  },
  2: {
    name: "ç¯€åˆ†",
    bg: "#fffbf0", accent: "#ef4444", sub: "#f59e0b",
    icons: ['ğŸ‘¹','ç¦','âœ¨','ğŸ¡','ğŸŒ¸','ğŸ«˜','ğŸ'],
    particle: 'beans',
    sound: 'japanese'
  },
  3: {
    name: "ã²ãªç¥­ã‚Š",
    bg: "#fff5f7", accent: "#ec4899", sub: "#a7f3d0", // æ¡ƒãƒ»è±é¤…(ç·‘)
    icons: ['ğŸ','ğŸ¡','ğŸŒ¸','ğŸ®','ğŸ‘','âœ¨'],
    particle: 'petals-peach',
    sound: 'japanese'
  },
  4: {
    name: "æ¡œ",
    bg: "#fff0f5", accent: "#f472b6", sub: "#fbcfe8",
    icons: ['ğŸŒ¸','ğŸ’','ğŸ«','ğŸŒ·','âœ¨','ğŸ±'],
    particle: 'sakura',
    sound: 'fanfare'
  },
  5: {
    name: "ã“ã©ã‚‚ã®æ—¥",
    bg: "#f0f9ff", accent: "#3b82f6", sub: "#4ade80", // é’ç©ºãƒ»æ–°ç·‘
    icons: ['ğŸ','ğŸ‹','ğŸªµ','ğŸŒ¿','âœ¨','ğŸ‘¦'],
    particle: 'fresh-green',
    sound: 'fanfare'
  },
  6: {
    name: "æ¢…é›¨",
    bg: "#f0fdfa", accent: "#6366f1", sub: "#0ea5e9", // ç´«é™½èŠ±ãƒ»é›¨
    icons: ['â˜‚ï¸','ğŸŒ','ğŸ’ ','ğŸŒˆ','ğŸ’§','ğŸ¸','âœ¨'],
    particle: 'rain',
    sound: 'calm-rain'
  },
  7: {
    name: "ä¸ƒå¤•",
    bg: "#eef2ff", accent: "#818cf8", sub: "#fcd34d", // å¤œç©ºãƒ»æ˜Ÿ
    icons: ['ğŸ‹','â­','ğŸŒŒ','ğŸ','âœ¨','ğŸ“'],
    particle: 'stars',
    sound: 'sparkle'
  },
  8: {
    name: "å¤ç¥­ã‚Š",
    bg: "#fff7ed", accent: "#f97316", sub: "#ef4444", // æç¯ãƒ»èŠ±ç«
    icons: ['ğŸ†','ğŸŒ»','ğŸ®','ğŸ§','ğŸ‘˜','âœ¨','ğŸ'],
    particle: 'fireworks',
    sound: 'fanfare'
  },
  9: {
    name: "ãŠæœˆè¦‹",
    bg: "#f5f3ff", accent: "#fbbf24", sub: "#a78bfa", // æœˆãƒ»å¤œ
    icons: ['ğŸŒ•','ğŸ‡','ğŸ¡','ğŸŒ¾','âœ¨','ğŸ '],
    particle: 'moon-sparkle',
    sound: 'calm-moon'
  },
  10: {
    name: "ãƒãƒ­ã‚¦ã‚£ãƒ³",
    bg: "#fff7ed", accent: "#f97316", sub: "#7c3aed", // ã‹ã¼ã¡ã‚ƒãƒ»ç´«
    icons: ['ğŸƒ','ğŸ‘»','ğŸ¬','ğŸ¦‡','ğŸ•¸ï¸','âœ¨','ğŸ­'],
    particle: 'halloween',
    sound: 'fanfare'
  },
  11: {
    name: "ç´…è‘‰",
    bg: "#fffbeb", accent: "#d97706", sub: "#b45309", // ç´…è‘‰ãƒ»ç§‹
    icons: ['ğŸ','ğŸ‚','ğŸŒ°','ğŸ¿ï¸','ğŸ„','âœ¨'],
    particle: 'autumn-leaves',
    sound: 'japanese'
  },
  12: {
    name: "ã‚¯ãƒªã‚¹ãƒã‚¹",
    bg: "#f0fdf4", accent: "#ef4444", sub: "#16a34a", // èµ¤ãƒ»ç·‘
    icons: ['ğŸ„','ğŸ…','â„ï¸','ğŸ','ğŸ¦Œ','âœ¨','ğŸ•¯ï¸'],
    particle: 'snow',
    sound: 'fanfare'
  }
};

const currentMonth = new Date().getMonth() + 1;
const SEASON_CONFIG = MONTH_THEMES[currentMonth];

/* --- è¨­å®šã®æ°¸ç¶šåŒ–ï¼ˆLocalStorageï¼‰ --- */
const STORAGE_KEYS = {
  TIMER_M: 'drill_timer_m',
  TIMER_S: 'drill_timer_s',
  CHIME_M: 'drill_chime_m',
  FX_MODE: 'drill_fx_mode_v2' // v2ã¸å¤‰æ›´ï¼ˆå¤ã„è¨­å®šã¨ã®ç«¶åˆå›é¿ï¼‰
};

let defaultSettings = {
  m: 25, s: 0, chime: 3, fxMode: 'seasonal'
};

function loadSettings(){
  const sm = localStorage.getItem(STORAGE_KEYS.TIMER_M);
  const ss = localStorage.getItem(STORAGE_KEYS.TIMER_S);
  const sc = localStorage.getItem(STORAGE_KEYS.CHIME_M);
  const fx = localStorage.getItem(STORAGE_KEYS.FX_MODE);
  
  if(sm !== null) defaultSettings.m = parseInt(sm);
  if(ss !== null) defaultSettings.s = parseInt(ss);
  if(sc !== null) defaultSettings.chime = parseInt(sc);
  if(fx !== null) defaultSettings.fxMode = fx;

  document.getElementById('mInput').value = defaultSettings.m;
  document.getElementById('sInput').value = defaultSettings.s;
  document.getElementById('chimeM').value = defaultSettings.chime;
  
  const radio = document.querySelector(`input[name="fxMode"][value="${defaultSettings.fxMode}"]`);
  if(radio) radio.checked = true;
}

loadSettings();

window.timerGlobal = {
  endTime: 0,
  totalMs: (defaultSettings.m * 60 + defaultSettings.s) * 1000,
  isRunning: false,
  isEnded: false,
  displayTime: `${defaultSettings.m.toString().padStart(2,'0')}:${defaultSettings.s.toString().padStart(2,'0')}`,
  displayNote: `ã‚»ãƒƒãƒˆ: ${defaultSettings.m}åˆ† ${defaultSettings.s}ç§’`
};

/* --- Sound Engine (Web Audio API) --- */
const SoundFX = {
  ctx: null, rumbleOsc: null, rumbleGain: null,
  init: function() {
    if (!this.ctx) { const AC = window.AudioContext || window.webkitAudioContext; this.ctx = new AC(); }
    if (this.ctx.state === 'suspended') this.ctx.resume();
  },
  createNoiseBuffer: function() {
    if (!this.ctx) return null;
    const size = this.ctx.sampleRate * 2; const buf = this.ctx.createBuffer(1, size, this.ctx.sampleRate);
    const data = buf.getChannelData(0); for (let i=0; i<size; i++) data[i] = Math.random() * 2 - 1; return buf;
  },
  playTone: function(freq, type, duration, vol, time) {
    if (!this.ctx) return; const t = time || this.ctx.currentTime;
    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, t);
    gain.gain.setValueAtTime(vol, t); gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
    osc.connect(gain).connect(this.ctx.destination); osc.start(t); osc.stop(t + duration);
  },
  chime: function() {
    if (!this.ctx) this.init(); if (!this.ctx) return; const now = this.ctx.currentTime;
    this.playTone(660, 'sine', 0.8, 0.15, now); this.playTone(550, 'sine', 1.2, 0.15, now + 0.6);
  },
  startRumble: function() { 
    if (!this.ctx) return; this.stopRumble();
    const noise = this.createNoiseBuffer(); const src = this.ctx.createBufferSource(); src.buffer = noise; src.loop = true;
    const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 120;
    const gain = this.ctx.createGain(); gain.gain.value = 0;
    src.connect(filter).connect(gain).connect(this.ctx.destination); src.start();
    gain.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 2);
    this.rumbleOsc = src; this.rumbleGain = gain;
  },
  stopRumble: function() {
    if (this.rumbleOsc) {
      try { this.rumbleGain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5); this.rumbleOsc.stop(this.ctx.currentTime + 0.5); } catch(e){}
      this.rumbleOsc = null;
    }
  },
  playPattern: function(type) {
    if (!this.ctx) return; const t = this.ctx.currentTime;
    if (type === 'japanese') {
        const notes = [523.25, 587.33, 659.25, 783.99, 880.00, 1046.50]; // é™½æ—‹æ³•
        notes.forEach((freq, i) => { this.playTone(freq, 'triangle', 0.3, 0.1, t + (i*0.15)); });
        // é¼“ã®ã‚ˆã†ãªéŸ³
        this.playTone(100, 'square', 0.1, 0.15, t);
        this.playTone(100, 'square', 0.1, 0.15, t+0.8);
    } else if (type === 'fanfare') {
        this.playTone(523.25, 'triangle', 0.2, 0.1, t); this.playTone(659.25, 'triangle', 0.2, 0.1, t + 0.1);
        this.playTone(783.99, 'triangle', 0.4, 0.1, t + 0.2); this.playTone(1046.50, 'triangle', 0.8, 0.1, t + 0.3);
        this.playTone(1046.50, 'triangle', 1.2, 0.1, t + 0.5);
    } else if (type === 'calm-rain' || type === 'calm-moon') {
        // ã‚¢ãƒ«ãƒšã‚¸ã‚ª
        [440, 554, 659, 880].forEach((f, i) => this.playTone(f, 'sine', 1.0, 0.08, t + i*0.2));
    } else if (type === 'sparkle') {
        for(let i=0; i<8; i++) this.playTone(1000 + i*200, 'sine', 0.1, 0.05, t + i*0.08);
    }
  },
  click: function() { if (!this.ctx) return; this.playTone(1000, 'sine', 0.1, 0.05); }
};

/* --- Visual FX (Canvas) --- */
const VisualFX = {
  canvas: document.getElementById('fxCanvas'), ctx: null, elements: [],
  init: function() {
    if(this.canvas){
      this.ctx = this.canvas.getContext('2d'); this.resize();
      window.addEventListener('resize', () => this.resize()); this.loop();
    }
  },
  resize: function() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
  
  emitParticles: function(type) {
    const w = this.canvas.width;
    const h = this.canvas.height;
    
    // Config per type
    let config = { count: 60, colors: ['#fff'], shape: 'circle', gravity: 5, drift: 0, yStart: -20 };
    
    if (type === 'confetti-gold') {
        config.colors = ['#fbbf24', '#fcd34d', '#fef08a', '#ef4444', '#ffffff'];
        config.shape = 'rect'; config.drift = 2;
    } else if (type === 'beans') {
        config.colors = ['#fcd34d', '#fbbf24', '#f59e0b', '#ffffff'];
        config.shape = 'oval'; config.gravity = 10;
    } else if (type === 'petals-peach' || type === 'sakura') {
        config.colors = (type==='sakura') ? ['#fbcfe8', '#f9a8d4', '#f472b6'] : ['#fbcfe8', '#f472b6', '#ec4899'];
        config.shape = 'petal'; config.gravity = 3; config.drift = 3;
    } else if (type === 'fresh-green' || type === 'autumn-leaves') {
        config.colors = (type==='fresh-green') ? ['#4ade80', '#22c55e', '#bbf7d0'] : ['#f87171', '#fb923c', '#fbbf24', '#854d0e'];
        config.shape = 'leaf'; config.gravity = 4; config.drift = 4;
    } else if (type === 'rain') {
        config.colors = ['#60a5fa', '#3b82f6', '#93c5fd'];
        config.shape = 'line'; config.gravity = 20; config.count = 100;
    } else if (type === 'stars' || type === 'moon-sparkle') {
        config.colors = ['#fcd34d', '#fef08a', '#fff'];
        config.shape = 'star'; config.gravity = 2; config.yStart = h/2; // Center burst handled in creation
    } else if (type === 'fireworks') {
        config.colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
        config.shape = 'circle'; config.gravity = 0; // radial
    } else if (type === 'halloween') {
        config.colors = ['#f97316', '#a855f7', '#000000'];
        config.shape = 'mix'; config.gravity = 6;
    } else if (type === 'snow') {
        config.colors = ['#ffffff', '#e2e8f0'];
        config.shape = 'circle'; config.gravity = 1.5; config.drift = 1;
    }

    for(let i=0; i<config.count; i++){
      let p = {
          x: Math.random() * w, 
          y: config.yStart,
          vx: (Math.random()-0.5) * config.drift, 
          vy: Math.random() * config.gravity + 2,
          color: config.colors[Math.floor(Math.random()*config.colors.length)],
          size: Math.random()*6 + 4,
          rot: Math.random()*Math.PI,
          vRot: (Math.random()-0.5)*0.2,
          alpha: 1,
          decay: 0.005 + Math.random()*0.01,
          shape: config.shape
      };
      
      // Special init for radial/fireworks
      if (type === 'fireworks' || (type === 'stars' && i%2===0)) {
          p.x = w/2; p.y = h/2;
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 15 + 5;
          p.vx = Math.cos(angle) * speed;
          p.vy = Math.sin(angle) * speed;
          p.decay = 0.015 + Math.random()*0.02;
      }
      this.elements.push(p);
    }
  },
  loop: function() {
    requestAnimationFrame(() => this.loop()); if(!this.ctx) return;
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    for(let i=this.elements.length-1; i>=0; i--){
      const el = this.elements[i]; el.alpha -= el.decay;
      if(el.alpha <= 0){ this.elements.splice(i, 1); continue; }
      
      el.x += el.vx; el.y += el.vy; el.rot += el.vRot;
      if(el.shape === 'line') el.vy *= 1.01; // accelerate rain
      if(el.shape !== 'circle' && el.shape !== 'line') el.vx *= 0.98; // air resistance for flat objects
      if(el.shape === 'fireworks' || el.shape === 'star') { el.vx *= 0.92; el.vy *= 0.92; el.vy += 0.1; } // gravity for burst

      this.ctx.save();
      this.ctx.translate(el.x, el.y);
      this.ctx.rotate(el.rot);
      this.ctx.globalAlpha = el.alpha;
      this.ctx.fillStyle = el.color;
      this.ctx.beginPath();
      
      if(el.shape === 'circle'){
          this.ctx.arc(0, 0, el.size, 0, Math.PI*2);
      } else if (el.shape === 'rect'){
          this.ctx.fillRect(-el.size/2, -el.size/2, el.size, el.size);
      } else if (el.shape === 'oval'){
          this.ctx.ellipse(0, 0, el.size, el.size*0.7, 0, 0, Math.PI*2);
      } else if (el.shape === 'line'){
          this.ctx.fillRect(0, 0, 2, el.size*3);
      } else if (el.shape === 'petal' || el.shape === 'leaf'){
          this.ctx.ellipse(0, 0, el.size, el.size*0.4, 0, 0, Math.PI*2);
      } else if (el.shape === 'star'){
          for(let j=0; j<5; j++){
             this.ctx.lineTo(Math.cos((18+j*72)/180*Math.PI)*el.size, -Math.sin((18+j*72)/180*Math.PI)*el.size);
             this.ctx.lineTo(Math.cos((54+j*72)/180*Math.PI)*el.size*0.5, -Math.sin((54+j*72)/180*Math.PI)*el.size*0.5);
          }
      } else if (el.shape === 'mix'){
          // Simple rect for Halloween mix
          this.ctx.fillRect(-el.size/2, -el.size/2, el.size, el.size);
      }
      this.ctx.fill();
      this.ctx.restore();
    }
  }
};
VisualFX.init();

/* --- App Logic --- */
// Tab Switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.target).classList.add('active');
        document.getElementById('copyCsvBtn').style.display = (tab.dataset.target === 'mode-group') ? 'inline-block' : 'none';
    });
});

const p1 = document.getElementById('p1'), p2 = document.getElementById('p2'), p3 = document.getElementById('p3'), p4 = document.getElementById('p4');
const resultsEl = document.getElementById('results'), luckyBox = document.getElementById('luckyBox'), luckyText = document.getElementById('luckyText');

const ANIMALS = ['ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸµ','ğŸ¦Š','ğŸ±','ğŸ¶','ğŸ¸','ğŸ¹','ğŸ°','ğŸ¦„','ğŸ”','ğŸ¦¦','ğŸ¦–','ğŸ¦’'];
const QUESTIONS = [
  "âœ¨ ã‚‚ã—ä½•ã®åˆ¶ç´„ã‚‚ãªã‹ã£ãŸã‚‰ã€æœ¬å½“ã¯ä½•ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ", "ğŸš€ 1å¹´å¾Œã€ã‚ãªãŸã¯ä½•ã‚’é”æˆã—ã¦ç¥æ¯ã‚’ã‚ã’ã¦ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸ“– ã‚‚ã—ä»Šã®ã‚ãªãŸã®äººç”ŸãŒã€Œæœ¬ã€ã ã¨ã—ãŸã‚‰ã€ä»Šã®ç« ã«ã©ã‚“ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ", "ğŸ‘´ 80æ­³ã«ãªã£ãŸã‚ãªãŸãŒã€ä»Šã®ã‚ãªãŸã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã™ã‚‹ã¨ã—ãŸã‚‰ï¼Ÿ",
  "ğŸŒ… ç†æƒ³çš„ãªã€Œæœ€é«˜ã®ä¸€æ—¥ã€ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã©ã‚“ãªã‚‚ã®ã§ã™ã‹ï¼Ÿ", "ğŸ’ª ã‚ãªãŸãŒã¾ã ä½¿ã„ãã‚Œã¦ã„ãªã„ã€Œã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‘ãƒ¯ãƒ¼ï¼ˆå¼·ã¿ï¼‰ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ¦¶ ãã®ç›®æ¨™ã®ãŸã‚ã«ã€ä»Šæ—¥è¸ã¿å‡ºã›ã‚‹ã€Œæœ€åˆã®ä¸€æ­©ã€ã¯ï¼Ÿ", "ğŸšª ä»Šã€å‹‡æ°—ã‚’å‡ºã—ã¦é–‹ã‘ã‚‹ã¹ãã€Œãƒ‰ã‚¢ã€ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
  "ğŸ ä»Šã€ã‚ãªãŸãŒèª°ã‹ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’ä¼ãˆã‚‹ã¨ã—ãŸã‚‰èª°ã§ã™ã‹ï¼Ÿ", "ğŸ§± ã‚ãªãŸã®äººç”Ÿã®åœŸå°ã¨ãªã£ã¦ã„ã‚‹ã€ŒæˆåŠŸä½“é¨“ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ§­ è¿·ã£ãŸã¨ãã€ã„ã¤ã‚‚ç«‹ã¡è¿”ã‚‹ã€ŒåŸç‚¹ã€ã¯ã©ã“ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ğŸ¯ ã“ã®æ™‚é–“ã®æœ€å¾Œã€ã©ã‚“ãªæ°—æŒã¡ã«ãªã£ã¦ã„ãŸã„ã§ã™ã‹ï¼Ÿ",
  "âš¡ï¸ ä»Šã€é›·ã«æ‰“ãŸã‚ŒãŸã‚ˆã†ãªè¡æ’ƒçš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™ã¨ã—ãŸã‚‰ï¼Ÿ", "âš¡ï¸ ã‚ãªãŸã®ä¸­ã§ã€ä»Šã«ã‚‚çˆ†ç™ºã—ãã†ãªã€Œæƒ…ç†±ã€ã‚„ã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã¯ã©ã“ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "â›ˆï¸ é›¨é™ã£ã¦åœ°å›ºã¾ã‚‹ã€‚æœ€è¿‘ã®å›°é›£ã‹ã‚‰å­¦ã‚“ã ã€Œã‚®ãƒ•ãƒˆã€ã¯ä½•ã§ã™ã‹ï¼Ÿ", "ğŸ’¡ æœ€è¿‘ã€ã€Œã‚ã£ï¼ã€ã¨æ°—ã¥ã„ãŸã“ã¨ï¼ˆã‚¢ãƒä½“é¨“ï¼‰ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ”¥ ã‚‚ã—ä»Šã€ç©ã¿ä¸Šã’ã¦ããŸã‚‚ã®ã‚’ä¸€åº¦å£Šã—ã¦ä½œã‚Šç›´ã™ã¨ã—ãŸã‚‰ã€ã©ã“ã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ", "ğŸŒªï¸ åµãŒéãå»ã£ãŸå¾Œã€ã‚ãªãŸã®æ‰‹å…ƒã«æ®‹ã‚‹ã€Œæœ¬å½“ã«å¤§åˆ‡ãªã‚‚ã®ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ˜ˆ æ­£ç›´ãªã¨ã“ã‚ã€ãã®ç›®æ¨™ã¯ã€Œèª°ã‹ã«ã¡ã‚„ã»ã‚„ã•ã‚ŒãŸã„ã€ã¨ã„ã†ä¸‹å¿ƒãŒä½•ï¼…ã‚ã‚Šã¾ã™ã‹ï¼Ÿ", "ğŸ·ï¸ ã‚ãªãŸãŒä»Šã€å•†å“æ£šã«ä¸¦ã‚“ã§ã„ã‚‹ã¨ã—ãŸã‚‰ã€èƒŒä¸­ã«ã¯ã©ã‚“ãªã€Œå–æ‰±æ³¨æ„ã€ã®ãƒ©ãƒ™ãƒ«ãŒè²¼ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ¤¥ ã€Œå¿™ã—ã„ã€ã¨è¨€ã„è¨³ã—ã¦ã„ã‚‹ã‘ã‚Œã©ã€æœ¬å½“ã¯ã€Œã‚„ã‚ŠãŸããªã„ã ã‘ã€ã®ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ", "ğŸ•¶ï¸ ã‚‚ã—ã€ã‚ãªãŸã®è‹¦æ‰‹ãªäººãŒä»Šã®ã‚ãªãŸã®ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã«ãªã£ãŸã‚‰ã€ã©ã‚“ãªå«Œå‘³ãªæ­£è«–ã‚’è¨€ã£ã¦ãã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸš® ã‚ãªãŸãŒæŠ±ãˆã¦ã„ã‚‹ãƒ—ãƒ©ã‚¤ãƒ‰ã®ä¸­ã§ã€ä»Šã™ãæ¨ã¦ã¦ã‚‚èª°ã‚‚å›°ã‚‰ãªã„ã€Œç²—å¤§ã‚´ãƒŸã€ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", "ã‚«ãƒ¬ãƒ¼ã®è¾›ã•ã€ã§è¡¨ã™ã¨ï¼Ÿï¼ˆç”˜å£ï¼Ÿæ¿€è¾›ï¼Ÿã‚³ã‚¯ãŒè¶³ã‚Šãªã„ï¼Ÿï¼‰",
  "ğŸ¤´ ã‚ãªãŸãŒã€Œåœ°çƒã®ç‹æ§˜ã€ã«ãªã‚Šã¾ã—ãŸã€‚æœ€åˆã«ä½œã‚‹ã€ç§åˆ©ç§æ¬²ã«ã¾ã¿ã‚ŒãŸæ³•å¾‹ã¯ï¼Ÿ", "ğŸ§™â€â™‚ï¸ é­”æ³•ã®æ–ã§ã€ä»Šã®çŠ¶æ³ã‚’ã€Œå‹•ç‰©ã€ã«å¤‰ãˆã‚‹ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªå‹•ç‰©ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ§Š å†·è”µåº«ã®å¥¥ã§å¿˜ã‚Œå»ã‚‰ã‚Œã¦ã„ã‚‹ã€Œä¿å†·å‰¤ã€ã®æ°—æŒã¡ã«ãªã£ã¦ã€ä»Šã®ä¸€è¨€ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚", "ğŸ”¥ ã‚ãªãŸãŒä»Šã€å¯†ã‹ã«ã€Œã‚ã„ã¤ã«ã¯è² ã‘ãŸããªã„ã€ã¨å«‰å¦¬ã—ã¦ã„ã‚‹ç›¸æ‰‹ã¯èª°ã§ã™ã‹ï¼Ÿ"
];

// çŠ¶æ…‹ç®¡ç†
let currentResult = { text: '', csv: '' };

// Array Shuffle Utility
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// Group Logic
function generateGroups(names, type) {
    const n = names.length;
    let baseSize = (type === 'A' || type === 'C') ? 3 : 2;
    let groups = [];
    const remainder = n % baseSize;
    let counts = { base: 0, extra: 0, smaller: 0 };
    if (baseSize === 2) {
        if (remainder === 0) { counts.base = n / 2; } 
        else { counts.extra = 1; counts.base = (n - 3) / 2; }
    } else {
        if (remainder === 0) { counts.base = n / 3; } 
        else if (remainder === 1) { counts.extra = 1; counts.base = (n - 4) / 3; } 
        else if (remainder === 2) { counts.smaller = 1; counts.base = (n - 2) / 3; }
    }
    let structure = [];
    for(let i=0; i<counts.base; i++) structure.push(baseSize);
    if(counts.extra > 0) structure.push(baseSize + 1);
    if(counts.smaller > 0) structure.push(baseSize - 1);
    return structure;
}

function solveShuffle(names, structure, historyMatrix) {
    let bestGroups = null;
    let minCost = Infinity;
    for (let attempt = 0; attempt < 50; attempt++) {
        let currentShuffled = shuffle([...names]);
        let ptr = 0;
        let currentGroups = [];
        let cost = 0;
        for (let size of structure) {
            let grp = currentShuffled.slice(ptr, ptr + size);
            ptr += size;
            currentGroups.push(grp);
            for (let i = 0; i < grp.length; i++) {
                for (let j = i + 1; j < grp.length; j++) {
                    let p1 = grp[i], p2 = grp[j];
                    if (historyMatrix[p1] && historyMatrix[p1][p2]) { cost += historyMatrix[p1][p2]; }
                }
            }
        }
        if (cost < minCost) { minCost = cost; bestGroups = currentGroups; if (cost === 0) break; }
    }
    return bestGroups;
}

function getFixedRoles(members, roundIdx) {
    const n = members.length;
    let roles = { coach: '', client: '', observers: [] };
    if (n === 2) {
        if (roundIdx % 2 === 0) { roles.coach = members[0]; roles.client = members[1]; }
        else { roles.coach = members[1]; roles.client = members[0]; }
    } else if (n === 3) {
        // [æ”¹ä¿®ç‚¹]: Cl -> Ob ã®æµã‚Œã«ã™ã‚‹ãŸã‚é€†å›è»¢ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´
        // Coach: 0 -> 2 -> 1
        const c = (3 - (roundIdx % 3)) % 3;
        // Client: 1 -> 0 -> 2
        const cl = (c + 1) % 3;
        roles.coach = members[c];
        roles.client = members[cl];
        roles.observers = members.filter((_, i) => i !== c && i !== cl);
    } else if (n === 4) {
        const patterns = [{c:0, cl:1}, {c:2, cl:3}, {c:1, cl:2}, {c:3, cl:0}, {c:0, cl:2}];
        const pat = patterns[roundIdx % patterns.length];
        roles.coach = members[pat.c]; roles.client = members[pat.cl];
        roles.observers = members.filter((_, i) => i !== pat.c && i !== pat.cl);
    }
    return roles;
}

function assignSmartRoles(members, history) {
    const getStats = (n) => history[n] || { c:0, cl:0, ob:0, last: null };
    let sortedForCoach = [...members].sort((a,b) => {
        const sa = getStats(a), sb = getStats(b);
        if(sa.c !== sb.c) return sa.c - sb.c;
        const aWasC = sa.last === 'Coach' ? 1 : 0;
        const bWasC = sb.last === 'Coach' ? 1 : 0;
        return (aWasC !== bWasC) ? aWasC - bWasC : Math.random() - 0.5;
    });
    const coach = sortedForCoach[0];
    let remaining = members.filter(n => n !== coach);
    let sortedForClient = [...remaining].sort((a,b) => {
        const sa = getStats(a), sb = getStats(b);
        if(sa.cl !== sb.cl) return sa.cl - sb.cl; 
        const aWasCl = sa.last === 'Client' ? 1 : 0;
        const bWasCl = sb.last === 'Client' ? 1 : 0;
        return (aWasCl !== bWasCl) ? aWasCl - bWasCl : Math.random() - 0.5;
    });
    const client = sortedForClient[0];
    const observers = members.filter(n => n !== coach && n !== client);
    if(!history[coach]) history[coach] = {c:0, cl:0, ob:0, last:null};
    history[coach].c++; history[coach].last = 'Coach';
    if(!history[client]) history[client] = {c:0, cl:0, ob:0, last:null};
    history[client].cl++; history[client].last = 'Client';
    observers.forEach(o => {
        if(!history[o]) history[o] = {c:0, cl:0, ob:0, last:null};
        history[o].ob++; history[o].last = 'Observer';
    });
    return { coach, client, observers };
}

function draw(){
  const isGroupMode = document.getElementById('mode-group').classList.contains('active');
  const fxMode = document.querySelector('input[name="fxMode"]:checked').value;
  localStorage.setItem(STORAGE_KEYS.FX_MODE, fxMode);
  resultsEl.innerHTML = "";
  luckyBox.classList.remove('show');
  
  let names = [];
  if (isGroupMode) { names = document.getElementById('bulkParticipants').value.split(/\r\n|\n|\r/).map(n=>n.trim()).filter(n=>n); } 
  else { names = [p1.value, p2.value, p3.value, p4.value].map(n=>n.trim()).filter(n=>n); }
  if (names.length < 2) { alert("2åä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  
  // Set Styles & Start FX
  document.body.classList.remove('mode-seasonal', 'mode-animal');
  if(fxMode === 'seasonal'){
      document.body.classList.add('mode-seasonal');
      // Set Season Colors
      document.body.style.setProperty('--season-bg', SEASON_CONFIG.bg);
      document.body.style.setProperty('--season-accent', SEASON_CONFIG.accent);
      document.body.style.setProperty('--season-sub', SEASON_CONFIG.sub);
      
      SoundFX.playPattern('sparkle'); // Pre-sound
  } else if(fxMode === 'animal'){
      document.body.classList.add('mode-animal');
      SoundFX.startRumble();
  }

  const question = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];
  const luckyIcon = (fxMode === 'seasonal') ? SEASON_CONFIG.icons[Math.floor(Math.random() * SEASON_CONFIG.icons.length)] : ANIMALS[Math.floor(Math.random() * ANIMALS.length)];

  const renderResults = () => {
    resultsEl.innerHTML = "";
    currentResult = { text: '', csv: '' };
    let personalSchedule = {};
    names.forEach(n => personalSchedule[n] = []);

    if (!isGroupMode) {
        const shuffled = shuffle([...names]);
        currentResult.csv = 'Pre-assign Room Name,Email Address\n'; 
        if (shuffled.length === 4) {
             currentResult.text += `â–  å‚åŠ è€…: ${shuffled.join(', ')} (4åä»•æ§˜)\n\n`;
             const patterns = [{c:0, cl:1, obs:[2,3]}, {c:2, cl:3, obs:[0,1]}, {c:1, cl:2, obs:[0,3]}, {c:3, cl:0, obs:[1,2]}];
             patterns.forEach((pat, i) => {
                 const card = document.createElement('div'); card.className = 'round';
                 if(fxMode==='seasonal') card.classList.add('seasonal-decorated');
                 if(fxMode==='animal') card.classList.add('festive');
                 card.innerHTML = `<h3><span class="badge">ç¬¬${i+1}å›</span> å‰²ã‚Šå½“ã¦</h3><div class="assign"></div>`;
                 const list = card.querySelector('.assign');
                 const addRoleRow = (roleName, pIndex) => {
                     const pName = shuffled[pIndex];
                     const row = document.createElement('div'); row.className = 'role';
                     if(fxMode!=='none') row.classList.add('struck');
                     let dispName = pName;
                     if(fxMode === 'animal' || fxMode === 'seasonal'){
                        const iconSet = (fxMode === 'seasonal') ? SEASON_CONFIG.icons : ANIMALS;
                        const icon = iconSet[Math.floor(Math.random() * iconSet.length)];
                        dispName = `<span class="deco-icon">${icon}</span> ${pName}`;
                     }
                     row.innerHTML = `<div class="tag">${roleName}</div><div class="name">${dispName}</div>`;
                     list.appendChild(row);
                     return pName;
                 };
                 currentResult.text += `[ç¬¬${i+1}å›]\n`;
                 currentResult.text += `- ã‚³ãƒ¼ãƒ: ${addRoleRow("ã‚³ãƒ¼ãƒ", pat.c)}\n`;
                 currentResult.text += `- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${addRoleRow("ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ", pat.cl)}\n`;
                 pat.obs.forEach(idx => { currentResult.text += `- ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼: ${addRoleRow("ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼", idx)}\n`; });
                 currentResult.text += "\n";
                 resultsEl.appendChild(card);
             });
        } else {
            const rolesList = shuffled.length === 2 ? ["ã‚³ãƒ¼ãƒ", "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"] : ["ã‚³ãƒ¼ãƒ", "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ", "ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼"];
            currentResult.text += `â–  å‚åŠ è€…: ${shuffled.join(', ')}\n\n`;
            for(let i=0; i<shuffled.length; i++){
                const card = document.createElement('div'); card.className = 'round';
                if(fxMode==='seasonal') card.classList.add('seasonal-decorated');
                if(fxMode==='animal') card.classList.add('festive');
                card.innerHTML = `<h3><span class="badge">ç¬¬${i+1}å›</span> å‰²ã‚Šå½“ã¦</h3><div class="assign"></div>`;
                const list = card.querySelector('.assign');
                rolesList.forEach((roleTag, roleIdx) => {
                    // [æ”¹ä¿®ç‚¹]: é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã‚‚ Cl -> Ob ã®é€†å›è»¢ãƒ­ã‚¸ãƒƒã‚¯ã«å¤‰æ›´
                    const pName = shuffled[(roleIdx - i + (shuffled.length * 10)) % shuffled.length];
                    const row = document.createElement('div'); row.className = 'role';
                    if(fxMode!=='none') row.classList.add('struck');
                    let dispName = pName;
                    if(fxMode === 'animal' || fxMode === 'seasonal'){
                        const iconSet = (fxMode === 'seasonal') ? SEASON_CONFIG.icons : ANIMALS;
                        const icon = iconSet[Math.floor(Math.random() * iconSet.length)];
                        dispName = `<span class="deco-icon">${icon}</span> ${pName}`;
                    }
                    row.innerHTML = `<div class="tag">${roleTag}</div><div class="name">${dispName}</div>`;
                    list.appendChild(row);
                    if(roleIdx === 0) currentResult.text += `[ç¬¬${i+1}å›]\n`;
                    currentResult.text += `- ${roleTag}: ${pName}\n`;
                });
                currentResult.text += "\n";
                resultsEl.appendChild(card);
            }
        }
    } else {
        const workType = document.querySelector('input[name="workType"]:checked').value;
        const roundCount = parseInt(document.getElementById('roundCount').value);
        const structure = generateGroups(names, workType);
        const isShuffle = (workType === 'C' || workType === 'D');
        let pairHistory = {}; let roleHistory = {};
        names.forEach(n => { pairHistory[n] = {}; roleHistory[n] = { c:0, cl:0, ob:0, last: null }; });
        let allRounds = []; let fixedGroups = null;
        if (!isShuffle) {
            let shuffledNames = shuffle([...names]); fixedGroups = []; let ptr = 0;
            structure.forEach(size => { fixedGroups.push(shuffledNames.slice(ptr, ptr+size)); ptr+=size; });
        }
        for (let r=0; r<roundCount; r++) {
            let groupsForRound = isShuffle ? solveShuffle(names, structure, pairHistory) : fixedGroups;
            if (isShuffle) {
                groupsForRound.forEach(grp => {
                    for(let i=0; i<grp.length; i++){
                        for(let j=i+1; j<grp.length; j++){
                            let p1 = grp[i], p2 = grp[j];
                            if(!pairHistory[p1][p2]) pairHistory[p1][p2] = 0;
                            if(!pairHistory[p2][p1]) pairHistory[p2][p1] = 0;
                            pairHistory[p1][p2]++; pairHistory[p2][p1]++;
                        }
                    }
                });
            }
            let roundData = { round: r+1, rooms: [] };
            if (r > 0) currentResult.csv += `\n`;
            currentResult.csv += `[Round ${r+1}] Zoom Import Data\nPre-assign Room Name,Email Address\n`;
            groupsForRound.forEach((members, gIdx) => {
                let roles = isShuffle ? assignSmartRoles(members, roleHistory) : getFixedRoles(members, r);
                roundData.rooms.push({ roomNum: gIdx+1, members: members, roles: roles });
                members.forEach(m => {
                    let rStr = (roles.coach === m) ? 'Coach' : (roles.client === m ? 'Client' : 'Ob');
                    personalSchedule[m].push({ round: r+1, room: gIdx+1, role: rStr });
                    currentResult.csv += `Room ${gIdx+1},${m}\n`;
                });
            });
            allRounds.push(roundData);
        }
        const scheduleBox = document.createElement('div'); scheduleBox.className = 'schedule-box'; scheduleBox.style.gridColumn = "1 / -1";
        scheduleBox.innerHTML = `<div class="schedule-header">ğŸ“‹ å€‹äººã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã“ã“ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™ï¼‰</div><div class="schedule-content"></div>`;
        const schContent = scheduleBox.querySelector('.schedule-content');
        let copyTextBuffer = "";
        names.sort().forEach(name => {
            const row = document.createElement('div'); row.className = 'sch-row';
            if(fxMode!=='none') row.classList.add('struck');
            let flowHtml = ''; let flowText = '';
            personalSchedule[name].forEach((step, i) => {
                if(i > 0) { flowHtml += `<span class="step-arrow">âœ</span>`; flowText += ` â†’ `; }
                let rShort = step.role === 'Coach' ? 'C' : (step.role === 'Client' ? 'Cl' : 'Ob');
                flowHtml += `<div class="flow-step"><span>R${step.round}:Room${step.room}</span><strong style="font-size:11px">${rShort}</strong></div>`;
                flowText += `R${step.round}:Room${step.room}(${rShort})`;
            });
            row.innerHTML = `<div class="sch-name">${name}</div><div class="sch-flow">${flowHtml}</div>`;
            schContent.appendChild(row);
            copyTextBuffer += `â–  ${name}: ${flowText}\n`;
        });
        resultsEl.appendChild(scheduleBox);
        currentResult.text = copyTextBuffer + `\nâš¡ï¸ å•ã„: ${question}`;
        const container = document.createElement('div'); container.className = 'matrix-container'; container.style.gridColumn = "1 / -1";
        const table = document.createElement('table'); table.className = 'matrix';
        const thead = document.createElement('thead'); const hRow = document.createElement('tr'); hRow.innerHTML = `<th>Round</th>`;
        for(let i=0; i<allRounds[0].rooms.length; i++) hRow.innerHTML += `<th>Room ${i+1}</th>`;
        thead.appendChild(hRow); table.appendChild(thead);
        const tbody = document.createElement('tbody');
        allRounds.forEach(rData => {
            const row = document.createElement('tr'); row.innerHTML = `<td style="font-weight:700;color:var(--muted)">Round ${rData.round}</td>`;
            rData.rooms.forEach(room => {
                const cell = document.createElement('td'); cell.className = 'matrix-cell';
                if(fxMode==='seasonal') cell.classList.add('seasonal-decorated', 'struck');
                if(fxMode==='animal') cell.classList.add('festive');
                cell.innerHTML = `<span class="role-line"><span class="role-badge rb-coach">ã‚³ãƒ¼ãƒ</span>${room.roles.coach}</span>` +
                                 `<span class="role-line"><span class="role-badge rb-client">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</span>${room.roles.client}</span>` +
                                 room.roles.observers.map(o => `<span class="role-line"><span class="role-badge rb-obs">ã‚ªãƒ–ã‚¶ãƒ¼ãƒ–</span>${o}</span>`).join('');
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
        table.appendChild(tbody); container.appendChild(table); resultsEl.appendChild(container);
    }
    if(fxMode === 'seasonal' || fxMode === 'animal') luckyText.innerHTML = `<span style="font-size:24px;display:block;margin-bottom:4px;">${luckyIcon}</span> ${question}`;
    else luckyText.textContent = question;
    luckyBox.classList.add('show');
    document.getElementById('redrawBtn').disabled = false;
    document.getElementById('copyBtn').disabled = false;
    if(isGroupMode) document.getElementById('copyCsvBtn').disabled = false;
  };

  if (fxMode === 'none') {
    renderResults();
  } else {
    setTimeout(() => {
      if(fxMode === 'seasonal'){
          SoundFX.playPattern(SEASON_CONFIG.sound); 
          VisualFX.emitParticles(SEASON_CONFIG.particle);
          document.body.classList.add('shaking');
          setTimeout(()=> document.body.classList.remove('shaking'), 500);
      } else if(fxMode === 'animal'){
          SoundFX.stopRumble(); SoundFX.playPattern('fanfare'); VisualFX.emitParticles('confetti-gold');
      }
      renderResults();
    }, 2500);
  }
}

document.getElementById('drawBtn').addEventListener('click', draw);
document.getElementById('redrawBtn').addEventListener('click', draw);
document.getElementById('copyBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(currentResult.text).then(()=>alert("çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
});
document.getElementById('copyCsvBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(currentResult.csv).then(()=>alert("Zoomç”¨CSVå½¢å¼ã§ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
});

// Update Theme on Mode Change immediately
const updateTheme = (mode) => {
    if(mode === 'seasonal'){
        document.body.classList.add('mode-seasonal');
        document.body.classList.remove('mode-animal');
        document.body.style.setProperty('--season-bg', SEASON_CONFIG.bg);
        document.body.style.setProperty('--season-accent', SEASON_CONFIG.accent);
        document.body.style.setProperty('--season-sub', SEASON_CONFIG.sub);
        document.getElementById('mainLogo').textContent = SEASON_CONFIG.icons[0]; // ãƒ­ã‚´ã‚’ãã®æœˆã®ã‚¢ã‚¤ã‚³ãƒ³ã«
    } else if (mode === 'animal'){
        document.body.classList.add('mode-animal');
        document.body.classList.remove('mode-seasonal');
        document.getElementById('mainLogo').textContent = 'ğŸ»';
    } else {
        document.body.classList.remove('mode-seasonal', 'mode-animal');
        document.getElementById('mainLogo').textContent = 'ğŸ‘¹';
    }
};

document.querySelectorAll('input[name="fxMode"]').forEach(r => {
    r.addEventListener('change', () => {
        SoundFX.click();
        updateTheme(r.value);
    });
});
// Init theme on load
const initMode = document.querySelector('input[name="fxMode"]:checked').value;
updateTheme(initMode);

/* --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ --- */
let timerInterval = null; let chimeEnabled = true; let chimeBeforeMs = defaultSettings.chime * 60 * 1000; let chimeFired = false;
const timeEl = document.getElementById('time'); const startBtn = document.getElementById('startPause'); const resetBtn = document.getElementById('resetTimer'); const endMsgEl = document.getElementById('endMsg'); const chimeToggle = document.getElementById('chimeToggle');

chimeToggle.addEventListener('change', (e) => { chimeEnabled = e.target.checked; SoundFX.click(); });
document.getElementById('applyChime').addEventListener('click', () => {
  const m = parseInt(document.getElementById('chimeM').value); chimeBeforeMs = m * 60 * 1000;
  document.getElementById('chimeNote').textContent = `å‘¼éˆ´: ${m}åˆ†å‰`; localStorage.setItem(STORAGE_KEYS.CHIME_M, m); SoundFX.click();
});
document.getElementById('applyCustom').addEventListener('click', () => {
  const m = parseInt(document.getElementById('mInput').value); const s = parseInt(document.getElementById('sInput').value);
  localStorage.setItem(STORAGE_KEYS.TIMER_M, m); localStorage.setItem(STORAGE_KEYS.TIMER_S, s); window.timerGlobal.totalMs = (m * 60 + s) * 1000; resetTimerState();
});
document.querySelectorAll('.chip').forEach(b => {
  b.addEventListener('click', () => {
    const m = parseInt(b.dataset.min); document.getElementById('mInput').value = m; document.getElementById('sInput').value = 0; document.getElementById('applyCustom').click();
  });
});

function updateTimeDisplay(ms) {
  const totalSec = Math.ceil(Math.max(0, ms) / 1000); const m = Math.floor(totalSec / 60); const s = totalSec % 60;
  const timeStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  timeEl.textContent = timeStr; window.timerGlobal.displayTime = timeStr;
}
function checkAlarms(remaining) {
  if (chimeEnabled && !chimeFired && remaining <= chimeBeforeMs && remaining > 0) { chimeFired = true; SoundFX.chime(); }
  if (remaining <= 0) {
    stopTimer(); timeEl.classList.add('ended'); endMsgEl.textContent = "âš¡ï¸ TIME'S UP!"; endMsgEl.classList.add('show'); window.timerGlobal.isEnded = true;
    const mode = document.querySelector('input[name="fxMode"]:checked').value;
    if(mode === 'seasonal') { 
        SoundFX.playPattern(SEASON_CONFIG.sound); 
        VisualFX.emitParticles(SEASON_CONFIG.particle);
    } 
    else if(mode === 'animal') { SoundFX.playPattern('fanfare'); VisualFX.emitParticles('confetti-gold'); } 
    else { SoundFX.chime(); }
  }
}
function tick() {
  if (!window.timerGlobal.isRunning) return;
  const remaining = window.timerGlobal.endTime - Date.now();
  updateTimeDisplay(remaining); checkAlarms(remaining);
  if (remaining > 0) timerInterval = requestAnimationFrame(tick);
}
function stopTimer() { window.timerGlobal.isRunning = false; cancelAnimationFrame(timerInterval); startBtn.textContent = "é–‹å§‹"; }
function resetTimerState() {
  stopTimer(); timeEl.classList.remove('ended'); endMsgEl.classList.remove('show');
  updateTimeDisplay(window.timerGlobal.totalMs); chimeFired = false; window.timerGlobal.isEnded = false;
  const m = Math.floor(window.timerGlobal.totalMs / 60000); const s = (window.timerGlobal.totalMs % 60000) / 1000;
  const note = `ã‚»ãƒƒãƒˆ: ${m}åˆ† ${s}ç§’`; document.getElementById('timeNote').textContent = note; window.timerGlobal.displayNote = note;
  document.getElementById('chimeNote').textContent = `å‘¼éˆ´: ${document.getElementById('chimeM').value}åˆ†å‰`;
  chimeBeforeMs = parseInt(document.getElementById('chimeM').value) * 60 * 1000;
  SoundFX.click();
}
resetTimerState();

startBtn.addEventListener('click', () => {
  if (window.timerGlobal.isRunning) { stopTimer(); startBtn.textContent = "å†é–‹"; } else {
    if (window.timerGlobal.isEnded || timeEl.textContent === "00:00") {
      if(timeEl.textContent === "00:00") { window.timerGlobal.endTime = Date.now() + window.timerGlobal.totalMs; chimeFired = false; timeEl.classList.remove('ended'); endMsgEl.classList.remove('show'); window.timerGlobal.isEnded = false; }
    } else { const parts = timeEl.textContent.split(':'); const currentMs = (parseInt(parts[0])*60 + parseInt(parts[1])) * 1000; window.timerGlobal.endTime = Date.now() + currentMs; }
    window.timerGlobal.isRunning = true; startBtn.textContent = "ä¸€æ™‚åœæ­¢"; SoundFX.init(); tick();
  }
});
resetBtn.addEventListener('click', resetTimerState);

document.getElementById('popupBtn').addEventListener('click', () => {
    const height = 300; const width = 340; const top = window.screen.availHeight - height;
    const w = window.open('', 'TimerPopup', `width=${width},height=${height},left=0,top=${top}`);
    w.document.write(`<!doctype html><html><head><title>Timer</title><style>body{font-family:system-ui,sans-serif;text-align:center;padding:16px;background:#f9fafb;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0;}.card{background:#fff;padding:20px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1);width:100%;max-width:280px;border:1px solid #e5e7eb;}#pTime{font-size:56px;font-weight:800;margin:0;font-variant-numeric:tabular-nums;color:#1f2937;}#pTime.ended{color:#ef4444;}#pNote{color:#6b7280;font-size:12px;margin-top:4px;margin-bottom:16px;font-weight:500;}.row{display:flex;gap:8px;justify-content:center;}button{flex:1;padding:10px;border-radius:8px;border:1px solid #e5e7eb;background:#fff;font-weight:700;color:#374151;cursor:pointer;transition:0.1s;font-size:13px;}button:active{transform:scale(0.96);background:#f3f4f6;}button.close{color:#b91c1c;border-color:#fecaca;background:#fef2f2;}</style></head><body><div class="card"><div id="pTime">--:--</div><div id="pNote">é¸æŠæ™‚é–“: --</div><div class="row"><button id="btnStart">é–‹å§‹/åœæ­¢</button><button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button><button id="btnClose" class="close">é–‰ã˜ã‚‹</button></div></div><script>const opener=window.opener;const timeEl=document.getElementById('pTime');const noteEl=document.getElementById('pNote');document.getElementById('btnStart').onclick=()=>opener.document.getElementById('startPause').click();document.getElementById('btnReset').onclick=()=>opener.document.getElementById('resetTimer').click();document.getElementById('btnClose').onclick=()=>window.close();setInterval(()=>{if(opener&&!opener.closed){const state=opener.timerGlobal;if(state.isRunning){const remaining=Math.max(0,state.endTime-Date.now());const totalSec=Math.ceil(remaining/1000);const m=Math.floor(totalSec/60);const s=totalSec%60;timeEl.textContent=m.toString().padStart(2,'0')+":"+s.toString().padStart(2,'0');timeEl.classList.remove('ended');}else{timeEl.textContent=state.displayTime;if(state.isEnded)timeEl.classList.add('ended');else timeEl.classList.remove('ended');}noteEl.textContent=state.displayNote.replace("ã‚»ãƒƒãƒˆ:","é¸æŠæ™‚é–“:");}},100);<\/script></body></html>`); w.document.close();
});

const consentOverlay = document.getElementById('consentOverlay');
if (sessionStorage.getItem('consented') === '1'){ consentOverlay.style.display='none'; document.getElementById('appRoot').removeAttribute('aria-hidden'); SoundFX.init(); }
document.getElementById('consentOk').addEventListener('click', () => { sessionStorage.setItem('consented', '1'); SoundFX.click(); consentOverlay.style.display='none'; document.getElementById('appRoot').removeAttribute('aria-hidden'); SoundFX.init(); });

})();
</script>
</body>
</html>
