<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Coaching ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ« - Storm Edition</title>
<style>
/* --- ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
:root{
  --bg:#ffffff; --ink:#1f2937; --muted:#6b7280; --border:#e5e7eb; 
  --accent:#3b82f6; --accent-2:#10b981; --card:#ffffff; 
  --shadow:0 10px 24px rgba(0,0,0,.06);
  /* é›·æ¼”å‡ºç”¨ã‚«ãƒ©ãƒ¼ */
  --storm-bg: #111827;
  --lightning: #e0f2fe;
  --electric: #0ea5e9;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  transition: background 1.5s ease;
}

/* ã‚¹ãƒˆãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼ˆæŠ½é¸ä¸­ã®æš—è»¢æ¼”å‡ºï¼‰ */
body.storm-mode { background: var(--storm-bg); color: #e5e7eb; }
body.storm-mode .panel, body.storm-mode .role { background: #1f2937; border-color: #374151; color: #f3f4f6; }
body.storm-mode h1, body.storm-mode .logo { filter: brightness(0.8); }

/* ç”»é¢æŒ¯å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
body.shaking { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
@keyframes shake {
  10%, 90% { transform: translate3d(-2px, 0, 0); }
  20%, 80% { transform: translate3d(4px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-8px, 0, 0); }
  40%, 60% { transform: translate3d(8px, 0, 0); }
}

.container{ max-width:1000px; margin:0 auto; padding:24px 16px 48px; position:relative; z-index:10; }

/* é›·æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
#fxCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

header{ display:flex; align-items:flex-start; gap:12px; margin-bottom:16px }
.logo{ width:42px; height:42px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#60a5fa); display:grid; place-items:center; color:#fff; font-weight:900; box-shadow:var(--shadow); }
h1{ font-size:22px; margin:0 }

.panel{
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:16px; box-shadow:var(--shadow); margin-bottom:16px;
  transition: background 0.3s, border-color 0.3s;
}

/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
.grid{ display:grid; grid-template-columns: repeat(3, minmax(180px,1fr)); gap:12px }
.field label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 6px }
.field input{
  width:100%; padding:12px 14px; background:#fff; color:var(--ink);
  border:1px solid var(--border); border-radius:12px; outline:none;
}
.field input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(59,130,246,.16); }

/* ãƒœã‚¿ãƒ³é¡ */
.buttons{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px }
button{
  appearance:none; border:none; cursor:pointer;
  padding:12px 16px; border-radius:12px; font-size:15px; font-weight:600;
  transition: transform .06s ease;
}
button:active{ transform:scale(0.96); }
.primary{ color:#fff; background:linear-gradient(135deg,var(--accent),#60a5fa); box-shadow:0 12px 28px rgba(59,130,246,.24); }
.secondary{ color:var(--ink); background:#fff; border:1px solid var(--border); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

/* çµæœã‚«ãƒ¼ãƒ‰ */
.results{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:14px; perspective: 1000px; }
.round{
  background:var(--card); border:1px solid var(--border);
  border-radius:16px; padding:14px; box-shadow:var(--shadow);
  min-height:164px; transition: all 0.3s; position: relative; overflow: hidden;
}
/* é›·ã«æ‰“ãŸã‚ŒãŸå¾Œã®å¸¯é›»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.round.electrified { border-color: var(--electric); box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); animation: pulseGlow 2s infinite alternate; }
@keyframes pulseGlow { from{box-shadow:0 0 10px rgba(59,130,246,0.2);} to{box-shadow:0 0 25px rgba(59,130,246,0.6);} }

.round h3{ margin:0 0 10px; font-size:15px; display:flex; align-items:center; gap:10px; color:var(--muted); }
.badge{ color:#064e3b; background:linear-gradient(135deg,var(--accent-2),#34d399); padding:2px 10px; border-radius:999px; font-weight:800; font-size:12px; }

.assign{ display:grid; gap:10px }
.role{
  display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px;
  background:#ffffff; border:1px solid var(--border); position:relative; overflow:hidden;
}
/* åå‰æ±ºå®šæ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
.role.struck { animation: strikeFlash 0.4s ease-out forwards; }
@keyframes strikeFlash { 0% { background: #fff; filter: brightness(3); } 50% { background: #e0f2fe; } 100% { background: var(--card); } }

.tag{ min-width:94px; text-align:center; color:#fff; background:linear-gradient(135deg,var(--accent),#60a5fa); border-radius:999px; font-size:12px; font-weight:800; padding:4px 10px; }
.name{ font-size:16px; font-weight:700; }
.placeholder{ color:var(--muted); font-weight:500; letter-spacing:.08em }

/* è³ªå•è¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ */
.lucky-box{
  margin-top:20px; padding:16px; border-radius:16px; background: #f9fafb; border: 1px solid var(--border);
  text-align:center; display:none; animation: popIn 0.4s ease-out;
}
.lucky-box.show{ display:block; }
@keyframes popIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

/* ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ */
.timer-wrap{ display:flex; flex-wrap:wrap; gap:16px; align-items:center; margin-top:10px; }
.timer-face{ min-width:240px; padding:16px; border:1px solid var(--border); border-radius:16px; background:#fff; box-shadow:var(--shadow); }
.time{ font-variant-numeric: tabular-nums; font-size:48px; font-weight:800; text-align:center; color:var(--ink); }
.time.ended{ color:#ef4444; }
.timer-sub{ text-align:center; color:var(--muted); font-size:12px; margin-top:4px }
.timer-end-msg{ text-align:center; color:#059669; font-size:14px; font-weight:700; margin-top:8px; opacity:0; }
.timer-end-msg.show{ opacity:1; }

.fx-row{ display:flex; align-items:center; gap:8px; margin-top:8px; color:var(--muted); font-size:13px; }
.preset-row, .custom-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.custom-row{ margin-top:12px; font-size:13px; color:var(--muted); }
.note{ font-weight:700; margin-right:4px; }
.num{ width:80px; padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-size:14px }

/* ãƒ•ãƒƒã‚¿ãƒ¼ */
.footer{ color:var(--muted); font-size:12px; margin-top:32px; border-top:1px solid var(--border); padding-top:12px; display:flex; flex-wrap: wrap; gap:10px; justify-content:space-between; align-items:center; }
.license{ padding:6px 10px; border-radius:10px; border:1px dashed var(--border); background:#fafafa; line-height: 1.4; }

/* åˆæ„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; padding:16px; z-index:2000; }
.dialog{ max-width:600px; width:100%; background:#fff; border-radius:16px; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,.4); }
.dialog h2{ margin:0 0 12px; font-size:20px; }
.bullet li{ margin:8px 0; line-height:1.6; color:#374151; }

@media (max-width:720px){ .grid{ grid-template-columns: 1fr } }
</style>
</head>
<body>

<canvas id="fxCanvas"></canvas>

<div id="consentOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="dialog">
    <h2 id="consentTitle">åˆæ„ã®ç¢ºèª</h2>
    <p>æœ¬ã‚¢ãƒ—ãƒªã¯ã€ã‚³ãƒ¼ãƒãƒ³ã‚°ã®ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ«ã‚’ã€ŒåŠ¹ç‡çš„ã«ãƒ»éŠã³å¿ƒã‚’ã‚‚ã£ã¦ã€è¡Œã†ãŸã‚ã®å ´ã¥ãã‚Šã‚’æ”¯æ´ã—ã¾ã™ã€‚å®‰å¿ƒãƒ»å®‰å…¨ãªå­¦ã³ã®ãŸã‚ã€ä»¥ä¸‹ã«åŒæ„ã®ã†ãˆé–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
    <ul class="bullet">
      <li><strong>å®ˆç§˜ç¾©å‹™</strong>: ã“ã“ã§è©±ã•ã‚ŒãŸå†…å®¹ã¯ç›¸æ‰‹ã®äº†æ‰¿ãªãå ´ã®å¤–ã«æŒã¡å‡ºã—ã¾ã›ã‚“ã€‚</li>
      <li><strong>å­¦ã³ã¨å®Ÿé¨“ã®å ´</strong>: å®Œç’§ã•ã§ã¯ãªãå­¦ã³ãƒ»æŒ‘æˆ¦ã‚’å°Šé‡ã—ã¾ã™ã€‚ã†ã¾ãã„ã‹ãªã„ã“ã¨ã‚‚å®Ÿé¨“ã®ä¸€éƒ¨ã§ã™ã€‚</li>
      <li><strong>å…±ã«å‰µã‚‹</strong>: ç›¸äº’æ‰¿èªãƒ»æ™‚é–“å³å®ˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ã€å ´ã‚’ä¸€ç·’ã«è‰¯ãã—ã¦ã„ãã¾ã™ã€‚</li>
    </ul>
    <div class="buttons" style="margin-top:20px; justify-content:center;">
      <button id="consentOk" class="primary" style="padding:12px 24px;">OKï¼ˆåŒæ„ã—ã¦å§‹ã‚ã‚‹ï¼‰</button>
    </div>
  </div>
</div>

<div class="container" aria-hidden="true" id="appRoot">
  <header>
    <div class="logo" aria-hidden="true">âš¡ï¸</div>
    <div>
      <h1>Coaching ã‚¹ã‚­ãƒ«ãƒ‰ãƒªãƒ«</h1>
    </div>
  </header>

  <section class="panel">
    <div style="font-weight:700;margin-bottom:8px">å‚åŠ è€…ã¨æŠ½é¸</div>
    <div class="grid">
      <div class="field"><label>å‚åŠ è€…1</label><input id="p1" type="text" placeholder="å‚åŠ è€…1"></div>
      <div class="field"><label>å‚åŠ è€…2</label><input id="p2" type="text" placeholder="å‚åŠ è€…2"></div>
      <div class="field"><label>å‚åŠ è€…3</label><input id="p3" type="text" placeholder="å‚åŠ è€…3"></div>
    </div>
    <div class="buttons">
      <button id="drawBtn" class="primary">æŠ½é¸ã™ã‚‹</button>
      <button id="redrawBtn" class="secondary" disabled>ã‚‚ã†ä¸€åº¦ æŠ½é¸</button>
      <button id="copyBtn" class="secondary" disabled>çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div class="fx-row">
      <input type="checkbox" id="fxToggle" checked> <label for="fxToggle">æŠ½é¸æ¼”å‡ºï¼ˆStorm Modeï¼‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
    </div>
  </section>

  <section id="results" class="results" aria-live="polite"></section>

  <div id="luckyBox" class="lucky-box">
    <div style="font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px">Topic</div>
    <div id="luckyText" class="lucky-text"></div>
  </div>

  <section class="panel" style="margin-top:16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:700;">ã‚¿ã‚¤ãƒãƒ¼</div>
      <div class="preset-row">
        <span class="note">ãƒ—ãƒªã‚»ãƒƒãƒˆ:</span>
        <button class="chip secondary" data-min="15">15åˆ†</button>
        <button class="chip secondary" data-min="25">25åˆ†</button>
        <button class="chip secondary" data-min="30">30åˆ†</button>
      </div>
    </div>

    <div class="custom-row">
      <span class="note">ã‚«ã‚¹ã‚¿ãƒ :</span>
      <input id="mInput" class="num" type="number" min="0" value="25"> åˆ†
      <input id="sInput" class="num" type="number" min="0" value="0"> ç§’
      <button id="applyCustom" class="secondary">é©ç”¨</button>
    </div>

    <div class="custom-row">
      <span class="note">å‘¼éˆ´ï¼ˆnåˆ†å‰ï¼‰:</span>
      <label for="chimeToggle" style="display:flex;align-items:center;gap:4px;margin-right:8px">
        <input type="checkbox" id="chimeToggle" checked> æœ‰åŠ¹
      </label>
      <input id="chimeM" class="num" type="number" min="0" value="3"> åˆ†å‰
      <button id="applyChime" class="secondary">è¨­å®š</button>
    </div>
    
    <div class="timer-wrap">
      <div class="timer-face">
        <div id="time" class="time">25:00</div> 
        <div id="timeNote" class="timer-sub">ã‚»ãƒƒãƒˆ: 25åˆ† 0ç§’</div>
        <div id="chimeNote" class="timer-sub">å‘¼éˆ´: 3åˆ†å‰</div>
        <div id="endMsg" class="timer-end-msg"></div>
      </div>
      <div class="buttons" style="flex:1">
        <button id="startPause" class="primary" style="padding:12px 32px">é–‹å§‹</button>
        <button id="resetTimer" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="popupBtn" class="secondary">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º</button>
      </div>
    </div>
  </section>

  <div class="footer">
    <div>Created by Naomitchy</div>
    <div class="license">ã“ã®ã‚¢ãƒ—ãƒªã¯ CC0 ï¼ˆè‘—ä½œæ¨©æ”¾æ£„ãƒ»No Rights Reservedï¼‰ç›¸å½“ã§æä¾›ã—ã¾ã™ã€‚å‡ºå…¸ä¸è¦ãƒ»æ”¹å¤‰ãƒ»å†é…å¸ƒã‚‚è‡ªç”±ã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</div>
  </div>
</div>

<script>
(function(){
'use strict';

/* --- è¨­å®šã®æ°¸ç¶šåŒ–ï¼ˆLocalStorageï¼‰ --- */
const STORAGE_KEYS = {
  TIMER_M: 'drill_timer_m',
  TIMER_S: 'drill_timer_s',
  CHIME_M: 'drill_chime_m'
};

// åˆæœŸè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
let defaultSettings = {
  m: 25, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ25åˆ†
  s: 0,
  chime: 3 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3åˆ†å‰
};

// ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
function loadSettings(){
  const sm = localStorage.getItem(STORAGE_KEYS.TIMER_M);
  const ss = localStorage.getItem(STORAGE_KEYS.TIMER_S);
  const sc = localStorage.getItem(STORAGE_KEYS.CHIME_M);
  
  if(sm !== null) defaultSettings.m = parseInt(sm);
  if(ss !== null) defaultSettings.s = parseInt(ss);
  if(sc !== null) defaultSettings.chime = parseInt(sc);

  // UIã«åæ˜ 
  document.getElementById('mInput').value = defaultSettings.m;
  document.getElementById('sInput').value = defaultSettings.s;
  document.getElementById('chimeM').value = defaultSettings.chime;
}

loadSettings();

// å¤–éƒ¨é€£æºç”¨ã®ã‚¹ãƒ†ãƒ¼ãƒˆï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‹ã‚‰å‚ç…§ã•ã‚Œã‚‹ï¼‰
window.timerGlobal = {
  endTime: 0,
  totalMs: (defaultSettings.m * 60 + defaultSettings.s) * 1000,
  isRunning: false,
  isEnded: false,
  displayTime: `${defaultSettings.m.toString().padStart(2,'0')}:${defaultSettings.s.toString().padStart(2,'0')}`,
  displayNote: `ã‚»ãƒƒãƒˆ: ${defaultSettings.m}åˆ† ${defaultSettings.s}ç§’`
};

/* --- Sound Engine (Web Audio API) --- */
const SoundFX = {
  ctx: null,
  enabled: true, // fxToggleã§åˆ¶å¾¡ã•ã‚Œã‚‹
  rumbleOsc: null,
  rumbleGain: null,
  
  init: function() {
    if (!this.ctx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      this.ctx = new AC();
    }
    if (this.ctx.state === 'suspended') this.ctx.resume();
  },

  createNoiseBuffer: function() {
    if (!this.ctx) return null;
    const size = this.ctx.sampleRate * 2;
    const buf = this.ctx.createBuffer(1, size, this.ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i=0; i<size; i++) data[i] = Math.random() * 2 - 1;
    return buf;
  },

  playTone: function(freq, type, duration, vol, time) {
    if (!this.enabled || !this.ctx) return;
    const t = time || this.ctx.currentTime;
    const osc = this.ctx.createOscillator();
    const gain = this.ctx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, t);
    gain.gain.setValueAtTime(vol, t);
    gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
    osc.connect(gain).connect(this.ctx.destination);
    osc.start(t);
    osc.stop(t + duration);
  },

  chime: function() {
    // å‘¼éˆ´ã¯æ¼”å‡ºOFFã§ã‚‚é³´ã‚‰ã™ï¼ˆå®Ÿç”¨æ©Ÿèƒ½ã®ãŸã‚ï¼‰ã€‚ãŸã ã—ç„¡åŠ¹è¨­å®šãªã‚‰é³´ã‚‰ãªã„ã€‚
    if (!this.ctx) this.init(); // å¿…è¦ãªã‚‰åˆæœŸåŒ–
    if (!this.ctx) return;
    const now = this.ctx.currentTime;
    this.playTone(660, 'sine', 0.8, 0.15, now);
    this.playTone(550, 'sine', 1.2, 0.15, now + 0.6);
  },

  startRumble: function() {
    if (!this.enabled || !this.ctx) return;
    this.stopRumble();
    const noise = this.createNoiseBuffer();
    const src = this.ctx.createBufferSource();
    src.buffer = noise;
    src.loop = true;
    const filter = this.ctx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 120;
    const gain = this.ctx.createGain();
    gain.gain.value = 0;
    src.connect(filter).connect(gain).connect(this.ctx.destination);
    src.start();
    gain.gain.linearRampToValueAtTime(0.5, this.ctx.currentTime + 2);
    this.rumbleOsc = src;
    this.rumbleGain = gain;
  },

  stopRumble: function() {
    if (this.rumbleOsc) {
      try {
        this.rumbleGain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
        this.rumbleOsc.stop(this.ctx.currentTime + 0.5);
      } catch(e){}
      this.rumbleOsc = null;
    }
  },

  thunder: function() {
    if (!this.enabled || !this.ctx) return;
    this.stopRumble();
    const t = this.ctx.currentTime;
    const noise = this.createNoiseBuffer();
    // ã‚¯ãƒ©ãƒƒã‚¯éŸ³
    const src1 = this.ctx.createBufferSource(); src1.buffer = noise;
    const filter1 = this.ctx.createBiquadFilter(); filter1.type = 'highpass'; filter1.frequency.value = 500;
    const gain1 = this.ctx.createGain(); gain1.gain.setValueAtTime(0.8, t); gain1.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
    src1.connect(filter1).connect(gain1).connect(this.ctx.destination); src1.start(t);
    // é‡ä½éŸ³
    const src2 = this.ctx.createBufferSource(); src2.buffer = noise;
    const filter2 = this.ctx.createBiquadFilter(); filter2.type = 'lowpass'; filter2.frequency.setValueAtTime(800, t); filter2.frequency.linearRampToValueAtTime(50, t + 1.5);
    const gain2 = this.ctx.createGain(); gain2.gain.setValueAtTime(1.0, t); gain2.gain.exponentialRampToValueAtTime(0.001, t + 2.5);
    src2.connect(filter2).connect(gain2).connect(this.ctx.destination); src2.start(t);
  },

  click: function() {
    if (!this.enabled || !this.ctx) return;
    this.playTone(1000, 'sine', 0.1, 0.05);
  }
};

/* --- Visual FX (Lightning) --- */
const VisualFX = {
  canvas: document.getElementById('fxCanvas'),
  ctx: null,
  flashes: [],
  enabled: true, // fxToggleã§åˆ¶å¾¡
  init: function() {
    if(this.canvas){
      this.ctx = this.canvas.getContext('2d');
      this.resize();
      window.addEventListener('resize', () => this.resize());
      this.loop();
    }
  },
  resize: function() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; },
  createBoltPath: function(x, y, len) {
    const path = [{x, y}];
    let currX = x, currY = y;
    while(currY < this.canvas.height + 100) {
      currX += (Math.random() - 0.5) * len * 2;
      currY += (Math.random() * len) + 10;
      path.push({x: currX, y: currY});
      if(Math.random() < 0.1) break;
    }
    return path;
  },
  strike: function() {
    if(!this.enabled) return;
    this.flashes.push({ type: 'screen', alpha: 0.9, decay: 0.08 });
    const startX = Math.random() * this.canvas.width;
    this.flashes.push({ type: 'bolt', path: this.createBoltPath(startX, -50, 30), alpha: 1, decay: 0.04, width: 3 });
  },
  loop: function() {
    requestAnimationFrame(() => this.loop());
    if(!this.ctx) return;
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
    if(!this.enabled) return; // æç”»ã‚¹ã‚­ãƒƒãƒ—

    for(let i=this.flashes.length-1; i>=0; i--){
      const f = this.flashes[i];
      f.alpha -= f.decay;
      if(f.alpha <= 0){ this.flashes.splice(i, 1); } else {
        if(f.type === 'screen') {
          this.ctx.fillStyle = `rgba(255,255,255,${f.alpha})`;
          this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);
        } else if(f.type === 'bolt') {
          this.ctx.beginPath();
          this.ctx.strokeStyle = `rgba(255, 255, 255, ${f.alpha})`;
          this.ctx.shadowBlur = 15; this.ctx.shadowColor = '#0ea5e9'; this.ctx.lineWidth = f.width;
          if(f.path.length > 0) {
            this.ctx.moveTo(f.path[0].x, f.path[0].y);
            for(let p of f.path) this.ctx.lineTo(p.x, p.y);
          }
          this.ctx.stroke(); this.ctx.shadowBlur = 0;
        }
      }
    }
  }
};
VisualFX.init();

/* --- App Logic --- */
const p1 = document.getElementById('p1'), p2 = document.getElementById('p2'), p3 = document.getElementById('p3');
const resultsEl = document.getElementById('results'), luckyBox = document.getElementById('luckyBox'), luckyText = document.getElementById('luckyText');
const fxToggle = document.getElementById('fxToggle');

// è¨­å®šåæ˜ 
SoundFX.enabled = fxToggle.checked;
VisualFX.enabled = fxToggle.checked;

// å…¨40å•ï¼šæ­£çµ±æ´¾ï¼‹é›·ãƒ†ãƒ¼ãƒï¼‹ä¸å¯§ãªæ¯’èˆŒï¼‹ã‚·ãƒ¥ãƒ¼ãƒ«
const QUESTIONS = [
  // ã€æ­£çµ±æ´¾ï¼šãƒ“ã‚¸ãƒ§ãƒ³ã¨å¸Œæœ›ã€‘
  "âœ¨ ã‚‚ã—ä½•ã®åˆ¶ç´„ã‚‚ãªã‹ã£ãŸã‚‰ã€æœ¬å½“ã¯ä½•ã‚’ã—ãŸã„ã§ã™ã‹ï¼Ÿ",
  "ğŸš€ 1å¹´å¾Œã€ã‚ãªãŸã¯ä½•ã‚’é”æˆã—ã¦ç¥æ¯ã‚’ã‚ã’ã¦ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸ“– ã‚‚ã—ä»Šã®ã‚ãªãŸã®äººç”ŸãŒã€Œæœ¬ã€ã ã¨ã—ãŸã‚‰ã€ä»Šã®ç« ã«ã©ã‚“ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ",
  "ğŸ‘´ 80æ­³ã«ãªã£ãŸã‚ãªãŸãŒã€ä»Šã®ã‚ãªãŸã«ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã™ã‚‹ã¨ã—ãŸã‚‰ï¼Ÿ",
  "ğŸŒ… ç†æƒ³çš„ãªã€Œæœ€é«˜ã®ä¸€æ—¥ã€ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã©ã‚“ãªã‚‚ã®ã§ã™ã‹ï¼Ÿ",
  "ğŸ’ª ã‚ãªãŸãŒã¾ã ä½¿ã„ãã‚Œã¦ã„ãªã„ã€Œã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‘ãƒ¯ãƒ¼ï¼ˆå¼·ã¿ï¼‰ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ¦¶ ãã®ç›®æ¨™ã®ãŸã‚ã«ã€ä»Šæ—¥è¸ã¿å‡ºã›ã‚‹ã€Œæœ€åˆã®ä¸€æ­©ã€ã¯ï¼Ÿ",
  "ğŸšª ä»Šã€å‹‡æ°—ã‚’å‡ºã—ã¦é–‹ã‘ã‚‹ã¹ãã€Œãƒ‰ã‚¢ã€ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
  "ğŸ ä»Šã€ã‚ãªãŸãŒèª°ã‹ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’ä¼ãˆã‚‹ã¨ã—ãŸã‚‰èª°ã§ã™ã‹ï¼Ÿ",
  "ğŸ§± ã‚ãªãŸã®äººç”Ÿã®åœŸå°ã¨ãªã£ã¦ã„ã‚‹ã€ŒæˆåŠŸä½“é¨“ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ§­ è¿·ã£ãŸã¨ãã€ã„ã¤ã‚‚ç«‹ã¡è¿”ã‚‹ã€ŒåŸç‚¹ã€ã¯ã©ã“ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ¯ ã“ã®æ™‚é–“ã®æœ€å¾Œã€ã©ã‚“ãªæ°—æŒã¡ã«ãªã£ã¦ã„ãŸã„ã§ã™ã‹ï¼Ÿ",

  // ã€é›·ãƒ»é–ƒãï¼šã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ç›´æ„Ÿã€‘
  "âš¡ï¸ ä»Šã€é›·ã«æ‰“ãŸã‚ŒãŸã‚ˆã†ãªè¡æ’ƒçš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™ã¨ã—ãŸã‚‰ï¼Ÿ",
  "âš¡ï¸ ã‚ãªãŸã®ä¸­ã§ã€ä»Šã«ã‚‚çˆ†ç™ºã—ãã†ãªã€Œæƒ…ç†±ã€ã‚„ã€Œã‚¨ãƒãƒ«ã‚®ãƒ¼ã€ã¯ã©ã“ã«ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "â›ˆï¸ é›¨é™ã£ã¦åœ°å›ºã¾ã‚‹ã€‚æœ€è¿‘ã®å›°é›£ã‹ã‚‰å­¦ã‚“ã ã€Œã‚®ãƒ•ãƒˆã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ’¡ æœ€è¿‘ã€ã€Œã‚ã£ï¼ã€ã¨æ°—ã¥ã„ãŸã“ã¨ï¼ˆã‚¢ãƒä½“é¨“ï¼‰ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ”¥ ã‚‚ã—ä»Šã€ç©ã¿ä¸Šã’ã¦ããŸã‚‚ã®ã‚’ä¸€åº¦å£Šã—ã¦ä½œã‚Šç›´ã™ã¨ã—ãŸã‚‰ã€ã©ã“ã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ",
  "ğŸŒªï¸ åµãŒéãå»ã£ãŸå¾Œã€ã‚ãªãŸã®æ‰‹å…ƒã«æ®‹ã‚‹ã€Œæœ¬å½“ã«å¤§åˆ‡ãªã‚‚ã®ã€ã¯ä½•ã§ã™ã‹ï¼Ÿ",

  // ã€ä¸å¯§ãªæ¯’èˆŒï¼šäººé–“ã®æ¥­ï¼ˆã”ã†ï¼‰ã¨è¦‹æ „ã€‘
  "ğŸ˜ˆ æ­£ç›´ãªã¨ã“ã‚ã€ãã®ç›®æ¨™ã¯ã€Œèª°ã‹ã«ã¡ã‚„ã»ã‚„ã•ã‚ŒãŸã„ã€ã¨ã„ã†ä¸‹å¿ƒãŒä½•ï¼…ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ·ï¸ ã‚ãªãŸãŒä»Šã€å•†å“æ£šã«ä¸¦ã‚“ã§ã„ã‚‹ã¨ã—ãŸã‚‰ã€èƒŒä¸­ã«ã¯ã©ã‚“ãªã€Œå–æ‰±æ³¨æ„ã€ã®ãƒ©ãƒ™ãƒ«ãŒè²¼ã£ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ¤¥ ã€Œå¿™ã—ã„ã€ã¨è¨€ã„è¨³ã—ã¦ã„ã‚‹ã‘ã‚Œã©ã€æœ¬å½“ã¯ã€Œã‚„ã‚ŠãŸããªã„ã ã‘ã€ã®ã“ã¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ•¶ï¸ ã‚‚ã—ã€ã‚ãªãŸã®ä»Šã®æ‚©ã¿ãŒã€Œæ‚²åŠ‡ã®ãƒ’ãƒ­ã‚¤ãƒ³ã‚’æ¼”ã˜ã‚‹ãŸã‚ã®è„šæœ¬ã€ã ã¨ã—ãŸã‚‰ã€è¦³å®¢ã¯ä½•ã¦è¨€ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸš® ã‚ãªãŸãŒæŠ±ãˆã¦ã„ã‚‹ãƒ—ãƒ©ã‚¤ãƒ‰ã®ä¸­ã§ã€ä»Šã™ãæ¨ã¦ã¦ã‚‚èª°ã‚‚å›°ã‚‰ãªã„ã€Œç²—å¤§ã‚´ãƒŸã€ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ",
  "ğŸ› ã€Œã„ã¤ã‹ã‚„ã‚Šã¾ã™ã€ã¨è¨€ã„ç¶šã‘ã¦ã€ãã‚ãã‚è³å‘³æœŸé™ãŒåˆ‡ã‚Œã‹ã‹ã£ã¦ã„ã‚‹å¤¢ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ",
  "ğŸ›‘ ã‚¢ã‚¯ã‚»ãƒ«ã‚’å…¨é–‹ã«è¸ã¿ãªãŒã‚‰ã€åŒæ™‚ã«ã€Œæ€–ã„ã€ã¨è¨€ã£ã¦ãƒ–ãƒ¬ãƒ¼ã‚­ã‚’è¸ã‚“ã§ã„ã‚‹ç†ç”±ã¯ãªã‚“ã§ã™ã‹ï¼Ÿ",
  "ğŸŒµ èª°ã‚‚è¦‹ã¦ã„ãªã„ã—ã€èª°ã«ã‚‚è¤’ã‚ã‚‰ã‚Œãªã„ã¨ã—ã¦ã‚‚ã€ã‚ãªãŸã¯ãã®åŠªåŠ›ã‚’ç¶šã‘ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ",
  "ğŸ¤ å¢“å ´ã¾ã§æŒã£ã¦ã„ãã¨æ±ºã‚ã¦ã„ã‚‹ã‘ã‚Œã©ã€æœ¬å½“ã¯ã“ã“ã§åãå‡ºã—ã¦ã—ã¾ã„ãŸã„ã€Œå¼±éŸ³ã€ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ’Š ãã®æ‚©ã¿ã«ã¤ã‘ã‚‹ã€Œç‰¹åŠ¹è–¬ã€ã‚’ç™ºæ˜ã—ã¾ã—ãŸã€‚è–¬ã®åå‰ã¨ã€ã¡ã‚‡ã£ã¨ã—ãŸå‰¯ä½œç”¨ã¯ä½•ã§ã™ã‹ï¼Ÿ",
  "ğŸ§± ã‚ãªãŸãŒè‡ªåˆ†ã§è‡ªåˆ†ã®å‘¨ã‚Šã«ç©ã¿ä¸Šã’ã¦ã—ã¾ã£ãŸã€Œå£ã€ã€å†…å´ã‹ã‚‰å£Šã™ãªã‚‰ä½•ã‚’ä½¿ã„ã¾ã™ã‹ï¼Ÿ",

  // ã€ã‚·ãƒ¥ãƒ¼ãƒ«ï¼†ã‚¦ã‚£ãƒƒãƒˆï¼šè¦–ç‚¹ã®å¼·åˆ¶ç§»å‹•ã€‘
  "ğŸ‘½ ã‚‚ã—å®‡å®™äººãŒä»Šã®ã‚ãªãŸã‚’è¦‹ã¦ã„ãŸã‚‰ã€æ¯æ˜Ÿã¸ã®ãƒ¬ãƒãƒ¼ãƒˆã«ä½•ã¨æ›¸ãã§ã—ã‚‡ã†ã‹ï¼Ÿ",
  "ğŸ‘Ÿ ã‚ãªãŸã®ã€Œé´ã€ãŒå–‹ã‚Šã ã—ã¾ã—ãŸã€‚ã€ŒãŠã„ã€ã‚‚ã£ã¨ã€‡ã€‡ã¸é€£ã‚Œã¦è¡Œã£ã¦ãã‚Œã‚ˆï¼ã€ã©ã“ã«è¡ŒããŸãŒã£ã¦ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸ¤– AIãƒ­ãƒœãƒƒãƒˆãŒã‚ãªãŸã®ã€Œå–æ‰±èª¬æ˜æ›¸ã€ã‚’ä½œã‚Šã¾ã—ãŸã€‚ä¸€ç•ªæœ€åˆã®ã€Œæ³¨æ„æ›¸ãã€ã«ã¯ä½•ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸˆ ã‚‚ã—ã‚ãªãŸãŒã€Œæ°—ã¾ãã‚Œãªãƒã‚³ã€ã ã£ãŸã‚‰ã€ä»Šã®æ‚©ã¿ã«å¯¾ã—ã¦ã©ã†åå¿œã—ã¾ã™ã‹ï¼Ÿï¼ˆå¯ã‚‹ï¼Ÿã²ã£ã‹ãï¼Ÿç„¡è¦–ï¼Ÿï¼‰",
  "ğŸ› ä»Šã®ã‚ãªãŸã®ç²¾ç¥çŠ¶æ…‹ã‚’ã€Œã‚«ãƒ¬ãƒ¼ã®è¾›ã•ã€ã§è¡¨ã™ã¨ï¼Ÿï¼ˆç”˜å£ï¼Ÿæ¿€è¾›ï¼Ÿã‚³ã‚¯ãŒè¶³ã‚Šãªã„ï¼Ÿï¼‰",
  "ğŸ¤´ ã‚ãªãŸãŒã€Œåœ°çƒã®ç‹æ§˜ã€ã«ãªã‚Šã¾ã—ãŸã€‚æœ€åˆã«ä½œã‚‹ã€ç§åˆ©ç§æ¬²ã«ã¾ã¿ã‚ŒãŸæ³•å¾‹ã¯ï¼Ÿ",
  "ğŸ§™â€â™‚ï¸ é­”æ³•ã®æ–ã§ã€ä»Šã®çŠ¶æ³ã‚’ã€Œå‹•ç‰©ã€ã«å¤‰ãˆã‚‹ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªå‹•ç‰©ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ",
  "ğŸ§Š å†·è”µåº«ã®å¥¥ã§å¿˜ã‚Œå»ã‚‰ã‚Œã¦ã„ã‚‹ã€Œä¿å†·å‰¤ã€ã®æ°—æŒã¡ã«ãªã£ã¦ã€ä»Šã®ä¸€è¨€ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
  "ğŸ‘» ã‚‚ã—ã€ã‚ãªãŸã®è‹¦æ‰‹ãªäººãŒä»Šã®ã‚ãªãŸã®ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã«ãªã£ãŸã‚‰ã€ã©ã‚“ãªå«Œå‘³ãªæ­£è«–ã‚’è¨€ã£ã¦ãã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
  "ğŸ”¥ ã‚ãªãŸãŒä»Šã€å¯†ã‹ã«ã€Œã‚ã„ã¤ã«ã¯è² ã‘ãŸããªã„ã€ã¨å«‰å¦¬ã—ã¦ã„ã‚‹ç›¸æ‰‹ã¯èª°ã§ã™ã‹ï¼Ÿ",
  "ğŸ¤¡ ã‚ãªãŸã®äººç”Ÿã‚’ã€ŒBç´šæ˜ ç”»ã€ã«ã™ã‚‹ãªã‚‰ã€ãƒã‚¹ã‚¿ãƒ¼ã®ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ã¯ä½•ã«ã—ã¾ã™ã‹ï¼Ÿ"
];

function draw(){
  const names = [p1.value, p2.value, p3.value].map(n=>n.trim()).filter(n=>n);
  if (names.length < 2) { alert("2åä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  
  luckyBox.classList.remove('show');
  resultsEl.innerHTML = "";
  
  const roles = names.length === 2 ? ["ã‚³ãƒ¼ãƒ", "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ"] : ["ã‚³ãƒ¼ãƒ", "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ", "ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼"];
  const cards = [];

  // ã‚«ãƒ¼ãƒ‰æ ä½œæˆ
  for(let i=0; i<names.length; i++){
    const card = document.createElement('div'); card.className = 'round';
    card.innerHTML = `<h3><span class="badge">ç¬¬${i+1}å›</span> å‰²ã‚Šå½“ã¦</h3><div class="assign"></div>`;
    const list = card.querySelector('.assign');
    roles.forEach(role => {
      const row = document.createElement('div'); row.className = 'role';
      row.innerHTML = `<div class="tag">${role}</div><div class="name placeholder">???</div>`;
      list.appendChild(row);
    });
    resultsEl.appendChild(card);
    cards.push(card);
  }

  // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ­ã‚¸ãƒƒã‚¯
  const shuffled = [...names];
  for (let i = shuffled.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; }
  const question = QUESTIONS[Math.floor(Math.random() * QUESTIONS.length)];

  // çµæœè¡¨ç¤ºãƒ»ã‚³ãƒ”ãƒ¼æº–å‚™é–¢æ•°
  const showResults = () => {
    cards.forEach((card, roundIdx) => {
      const rows = card.querySelectorAll('.role');
      rows.forEach((row, roleIdx) => {
        row.querySelector('.name').textContent = shuffled[(roundIdx + roleIdx) % names.length];
        row.querySelector('.name').classList.remove('placeholder');
      });
    });
    luckyText.textContent = question;
    luckyBox.classList.add('show');
    document.getElementById('redrawBtn').disabled = false;
    document.getElementById('copyBtn').disabled = false;
    
    let txt = "";
    cards.forEach((c, i) => {
      txt += `[ç¬¬${i+1}å›]\n`;
      c.querySelectorAll('.role').forEach(r => txt += `- ${r.querySelector('.tag').textContent}: ${r.querySelector('.name').textContent}\n`);
      txt += "\n";
    });
    document.getElementById('copyBtn').dataset.text = txt + `\nâš¡ï¸ å•ã„: ${luckyText.textContent}`;
  };

  // æ¼”å‡ºåˆ†å²
  if (fxToggle.checked) {
    // æ¼”å‡ºã‚¢ãƒªï¼ˆStorm Modeï¼‰
    document.body.classList.add('storm-mode');
    SoundFX.startRumble();

    setTimeout(() => {
      SoundFX.thunder();
      VisualFX.strike();
      document.body.classList.add('shaking');
      setTimeout(()=> document.body.classList.remove('shaking'), 500);
      document.body.classList.remove('storm-mode');

      cards.forEach(c => c.classList.add('electrified'));
      // åå‰è¡¨ç¤ºãƒ•ãƒ©ãƒƒã‚·ãƒ¥
      cards.forEach(c => c.querySelectorAll('.role').forEach(r => r.classList.add('struck')));
      
      showResults();
    }, 2500);
  } else {
    // æ¼”å‡ºãƒŠã‚·ï¼ˆå³æ™‚è¡¨ç¤ºï¼‰
    showResults();
  }
}

document.getElementById('drawBtn').addEventListener('click', draw);
document.getElementById('redrawBtn').addEventListener('click', draw);
document.getElementById('copyBtn').addEventListener('click', () => navigator.clipboard.writeText(document.getElementById('copyBtn').dataset.text).then(()=>alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ")));

/* --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ --- */
let timerInterval = null;
let chimeEnabled = true;
let chimeBeforeMs = defaultSettings.chime * 60 * 1000;
let chimeFired = false;

const timeEl = document.getElementById('time');
const startBtn = document.getElementById('startPause');
const resetBtn = document.getElementById('resetTimer');
const endMsgEl = document.getElementById('endMsg');
const chimeToggle = document.getElementById('chimeToggle');

chimeToggle.addEventListener('change', (e) => { 
  chimeEnabled = e.target.checked; 
  if(SoundFX.enabled) SoundFX.click(); 
});

document.getElementById('applyChime').addEventListener('click', () => {
  const m = parseInt(document.getElementById('chimeM').value);
  chimeBeforeMs = m * 60 * 1000;
  document.getElementById('chimeNote').textContent = `å‘¼éˆ´: ${m}åˆ†å‰`;
  
  // è¨­å®šä¿å­˜
  localStorage.setItem(STORAGE_KEYS.CHIME_M, m);
  if(SoundFX.enabled) SoundFX.click();
});

// ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“é©ç”¨
document.getElementById('applyCustom').addEventListener('click', () => {
  const m = parseInt(document.getElementById('mInput').value);
  const s = parseInt(document.getElementById('sInput').value);
  
  // è¨­å®šä¿å­˜
  localStorage.setItem(STORAGE_KEYS.TIMER_M, m);
  localStorage.setItem(STORAGE_KEYS.TIMER_S, s);

  window.timerGlobal.totalMs = (m * 60 + s) * 1000;
  resetTimerState();
});

// ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
document.querySelectorAll('.chip').forEach(b => {
  b.addEventListener('click', () => {
    const m = parseInt(b.dataset.min);
    document.getElementById('mInput').value = m;
    document.getElementById('sInput').value = 0;
    document.getElementById('applyCustom').click();
  });
});

function updateTimeDisplay(ms) {
  const totalSec = Math.ceil(Math.max(0, ms) / 1000);
  const m = Math.floor(totalSec / 60);
  const s = totalSec % 60;
  const timeStr = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  timeEl.textContent = timeStr;
  window.timerGlobal.displayTime = timeStr; // ã‚°ãƒ­ãƒ¼ãƒãƒ«é€£æºæ›´æ–°
}

function checkAlarms(remaining) {
  if (chimeEnabled && !chimeFired && remaining <= chimeBeforeMs && remaining > 0) {
    chimeFired = true;
    SoundFX.chime();
  }
  if (remaining <= 0) {
    stopTimer();
    timeEl.classList.add('ended');
    endMsgEl.textContent = "âš¡ï¸ TIME'S UP!";
    endMsgEl.classList.add('show');
    window.timerGlobal.isEnded = true; // ã‚°ãƒ­ãƒ¼ãƒãƒ«é€£æº
    if(SoundFX.enabled) SoundFX.thunder();
    if(VisualFX.enabled) VisualFX.strike();
  }
}

function tick() {
  if (!window.timerGlobal.isRunning) return;
  const remaining = window.timerGlobal.endTime - Date.now();
  updateTimeDisplay(remaining);
  checkAlarms(remaining);
  if (remaining > 0) timerInterval = requestAnimationFrame(tick);
}

function stopTimer() {
  window.timerGlobal.isRunning = false;
  cancelAnimationFrame(timerInterval);
  startBtn.textContent = "é–‹å§‹";
}

function resetTimerState() {
  stopTimer();
  timeEl.classList.remove('ended');
  endMsgEl.classList.remove('show');
  updateTimeDisplay(window.timerGlobal.totalMs);
  chimeFired = false;
  window.timerGlobal.isEnded = false;
  
  const m = Math.floor(window.timerGlobal.totalMs / 60000);
  const s = (window.timerGlobal.totalMs % 60000) / 1000;
  const note = `ã‚»ãƒƒãƒˆ: ${m}åˆ† ${s}ç§’`;
  document.getElementById('timeNote').textContent = note;
  window.timerGlobal.displayNote = note;
  
  // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚UIã‚’æ•´åˆã•ã›ã‚‹
  document.getElementById('chimeNote').textContent = `å‘¼éˆ´: ${document.getElementById('chimeM').value}åˆ†å‰`;
  chimeBeforeMs = parseInt(document.getElementById('chimeM').value) * 60 * 1000;

  if(SoundFX.enabled) SoundFX.click();
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸè¡¨ç¤ºæ›´æ–°
resetTimerState();

startBtn.addEventListener('click', () => {
  if (window.timerGlobal.isRunning) {
    stopTimer();
    startBtn.textContent = "å†é–‹";
  } else {
    // çµ‚äº†çŠ¶æ…‹ã‹ã‚‰ã®å†é–‹ãªã‚‰ãƒªã‚»ãƒƒãƒˆ
    if (window.timerGlobal.isEnded || timeEl.textContent === "00:00") {
      const parts = timeEl.textContent.split(':');
      if(parts[0]=="00" && parts[1]=="00") {
          window.timerGlobal.endTime = Date.now() + window.timerGlobal.totalMs;
          chimeFired = false;
          timeEl.classList.remove('ended');
          endMsgEl.classList.remove('show');
          window.timerGlobal.isEnded = false;
      }
    } else {
       const parts = timeEl.textContent.split(':');
       const currentMs = (parseInt(parts[0])*60 + parseInt(parts[1])) * 1000;
       window.timerGlobal.endTime = Date.now() + currentMs;
    }
    
    window.timerGlobal.isRunning = true;
    startBtn.textContent = "ä¸€æ™‚åœæ­¢";
    SoundFX.init();
    tick();
  }
});

resetBtn.addEventListener('click', resetTimerState);

/* --- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ (æ”¹è‰¯ç‰ˆ: å·¦ä¸‹å›ºå®šãƒ»ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‹•ä½œå¯¾å¿œãƒ»ãƒœã‚¿ãƒ³å¾©å…ƒ) --- */
document.getElementById('popupBtn').addEventListener('click', () => {
    // ç”»é¢å·¦ä¸‹ã«é…ç½® (é«˜ã•300pxã¨ä»®å®š)
    const height = 300;
    const width = 340;
    const top = window.screen.availHeight - height;
    
    const w = window.open('', 'TimerPopup', `width=${width},height=${height},left=0,top=${top}`);
    
    // HTMLæ§‹ç¯‰
    w.document.write(`
      <!doctype html>
      <html><head><title>Timer</title>
      <style>
        body{ 
          font-family:system-ui,sans-serif; text-align:center; padding:16px; 
          background:#f9fafb; display:flex; flex-direction:column; 
          align-items:center; justify-content:center; height:100vh; margin:0; 
        }
        .card {
          background:#fff; padding:20px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1);
          width:100%; max-width:280px; border:1px solid #e5e7eb;
        }
        #pTime { font-size:56px; font-weight:800; margin:0; font-variant-numeric: tabular-nums; color:#1f2937; }
        #pTime.ended { color:#ef4444; }
        #pNote { color:#6b7280; font-size:12px; margin-top:4px; margin-bottom:16px; font-weight:500; }
        .row { display:flex; gap:8px; justify-content:center; }
        button {
          flex:1; padding:10px; border-radius:8px; border:1px solid #e5e7eb; 
          background:#fff; font-weight:700; color:#374151; cursor:pointer;
          transition:0.1s; font-size:13px;
        }
        button:active { transform:scale(0.96); background:#f3f4f6; }
        button.close { color:#b91c1c; border-color:#fecaca; background:#fef2f2; }
      </style>
      </head><body>
      <div class="card">
        <div id="pTime">--:--</div>
        <div id="pNote">é¸æŠæ™‚é–“: --</div>
        <div class="row">
          <button id="btnStart">é–‹å§‹/åœæ­¢</button>
          <button id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnClose" class="close">é–‰ã˜ã‚‹</button>
        </div>
      </div>
      <script>
        const opener = window.opener;
        const timeEl = document.getElementById('pTime');
        const noteEl = document.getElementById('pNote');
        
        // ãƒœã‚¿ãƒ³æ“ä½œã‚’è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«å§”è­²
        document.getElementById('btnStart').onclick = () => opener.document.getElementById('startPause').click();
        document.getElementById('btnReset').onclick = () => opener.document.getElementById('resetTimer').click();
        document.getElementById('btnClose').onclick = () => window.close();

        // ç‹¬è‡ªã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã§æ™‚é–“ã‚’å†è¨ˆç®—ï¼ˆè¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒãƒ•ãƒªãƒ¼ã‚ºã—ã¦ã‚‚å‹•ãã‚ˆã†ã«ï¼‰
        setInterval(()=>{
           if(opener && !opener.closed){
              const state = opener.timerGlobal; // è¦ªã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å‚ç…§
              
              if(state.isRunning) {
                 // å®Ÿè¡Œä¸­ã¯è¦ªã®endTimeã‹ã‚‰ç¾åœ¨æ™‚åˆ»ã‚’å¼•ã„ã¦ç‹¬è‡ªã«è¨ˆç®—
                 const remaining = Math.max(0, state.endTime - Date.now());
                 const totalSec = Math.ceil(remaining / 1000);
                 const m = Math.floor(totalSec / 60);
                 const s = totalSec % 60;
                 timeEl.textContent = m.toString().padStart(2,'0') + ":" + s.toString().padStart(2,'0');
                 timeEl.classList.remove('ended');
              } else {
                 // åœæ­¢ä¸­ã¯è¦ªã®è¡¨ç¤ºã‚’ã‚³ãƒ”ãƒ¼ï¼ˆè¦ªãŒãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸå ´åˆãªã©ã‚’åæ˜ ï¼‰
                 timeEl.textContent = state.displayTime;
                 if(state.isEnded) timeEl.classList.add('ended');
                 else timeEl.classList.remove('ended');
              }
              
              // é¸æŠæ™‚é–“ã®è¡¨ç¤ºæ›´æ–°
              noteEl.textContent = state.displayNote.replace("ã‚»ãƒƒãƒˆ:", "é¸æŠæ™‚é–“:");
           }
        }, 100);
      <\/script></body></html>
    `);
    w.document.close();
});

// åˆæœŸåŒ–
const consentOverlay = document.getElementById('consentOverlay');
if (sessionStorage.getItem('consented') === '1'){ consentOverlay.style.display='none'; document.getElementById('appRoot').removeAttribute('aria-hidden'); SoundFX.init(); }
document.getElementById('consentOk').addEventListener('click', () => { sessionStorage.setItem('consented', '1'); SoundFX.click(); consentOverlay.style.display='none'; document.getElementById('appRoot').removeAttribute('aria-hidden'); SoundFX.init(); });
document.getElementById('fxToggle').addEventListener('change', (e) => { 
  // æ¼”å‡ºå…¨èˆ¬ã®ON/OFFåˆ¶å¾¡
  SoundFX.enabled = e.target.checked; 
  VisualFX.enabled = e.target.checked;
  if(e.target.checked) SoundFX.click(); 
});

})();
</script>
</body>
</html>
